<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì—¬í–‰ì´ - AI ì—¬í–‰ í”Œë˜ë„ˆ</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7c3aed">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- React 18 CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50:'#f5f3ff',100:'#ede9fe',200:'#ddd6fe',300:'#c4b5fd',400:'#a78bfa',500:'#8b5cf6',600:'#7c3aed',700:'#6d28d9',800:'#5b21b6',900:'#4c1d95' }
          }
        }
      }
    }
  </script>

  <link rel="stylesheet" href="assets/styles/custom.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useReducer, useRef, useCallback } = React;

    // â”€â”€â”€ API ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API_BASE = (() => {
      const hostname = window.location.hostname;
      const port = 3000;

      // í”„ë¡œë•ì…˜ í™˜ê²½ (ë„ë©”ì¸ì´ ìˆëŠ” ê²½ìš°)
      if (hostname !== 'localhost' && hostname !== '127.0.0.1' &&
          !hostname.match(/^192\.168\./) && !hostname.match(/^10\./) &&
          !hostname.match(/^172\.(1[6-9]|2\d|3[01])\./)) {
        return ''; // ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
      }

      // ê°œë°œ í™˜ê²½ (localhost ë˜ëŠ” ë¡œì»¬ IP)
      return `http://${hostname}:${port}`;
    })();

    console.log('ğŸ”— API Base URL:', API_BASE || '(ìƒëŒ€ ê²½ë¡œ)');

    async function api(endpoint, options = {}) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error(`API ${endpoint}:`, err);
        return null;
      }
    }

    // â”€â”€â”€ ìƒíƒœ ê´€ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STAGES = { PROJECTS: 'PROJECTS', CONSULTING: 'CONSULTING', PLANNING: 'PLANNING', EXECUTION: 'EXECUTION' };

    const initialState = {
      stage: STAGES.CONSULTING,
      aiMode: 'unknown',
      quotaExceeded: false,
      resetTime: null,
      userSettings: { homeCity: 'ì„œìš¸', homeCountry: 'ëŒ€í•œë¯¼êµ­', defaultTravelers: 2, defaultBudget: 2000000, defaultDeparture: 'ICN', fuelEfficiency: 10, fuelPrice: 1700 }, // ì „ì—­ ì„¤ì •
      consulting: { messages: [], sessionId: `session-${Date.now()}`, recommendations: [], state: 'GREETING', context: {} },
      project: null,
      itinerary: null
    };

    function loadState() {
      try {
        const saved = localStorage.getItem('travelPMS_state');
        if (saved) {
          const parsed = JSON.parse(saved);

          // ë°ì´í„° ë²„ì „ ì²´í¬ (ì˜¤ë˜ëœ ë°ì´í„°ëŠ” ë¬´ì‹œ)
          const DATA_VERSION = 3;  // ë²„ì „ ì—…ë°ì´íŠ¸ (userSettings ì¶”ê°€)
          if (!parsed._version || parsed._version < DATA_VERSION) {
            console.log('âš ï¸ ì˜¤ë˜ëœ localStorage ë°ì´í„° ê°ì§€, í´ë¦¬ì–´í•©ë‹ˆë‹¤.');
            localStorage.removeItem('travelPMS_state');
            return { ...initialState, stage: STAGES.PROJECTS, _version: DATA_VERSION };
          }

          // userSettings ê¸°ë³¸ê°’ ì„¤ì •
          if (!parsed.userSettings) {
            parsed.userSettings = { homeCity: 'ì„œìš¸', homeCountry: 'ëŒ€í•œë¯¼êµ­', defaultTravelers: 2, defaultBudget: 2000000, defaultDeparture: 'ICN', fuelEfficiency: 10, fuelPrice: 1700 };
          } else {
            // ê¸°ì¡´ ì„¤ì •ì— ìƒˆ í•„ë“œ ì¶”ê°€
            parsed.userSettings = {
              ...parsed.userSettings,
              homeCity: parsed.userSettings.homeCity || 'ì„œìš¸',
              defaultTravelers: parsed.userSettings.defaultTravelers || 2,
              defaultBudget: parsed.userSettings.defaultBudget || 2000000,
              defaultDeparture: parsed.userSettings.defaultDeparture || 'ICN',
              fuelEfficiency: parsed.userSettings.fuelEfficiency || 10,
              fuelPrice: parsed.userSettings.fuelPrice || 1700
            };
          }

          // í•­ìƒ í”„ë¡œì íŠ¸ ëª©ë¡ í™”ë©´ë¶€í„° ì‹œì‘
          if (parsed.project) return { ...parsed, stage: STAGES.PROJECTS };
        }
      } catch (_) {}
      // í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ í”„ë¡œì íŠ¸ ëª©ë¡ í™”ë©´ìœ¼ë¡œ
      return { ...initialState, stage: STAGES.PROJECTS, _version: 3 };
    }

    function reducer(state, action) {
      let next;
      switch (action.type) {
        case 'SET_AI_MODE':
          next = {
            ...state,
            aiMode: action.payload.aiMode || action.payload,
            quotaExceeded: action.payload.quotaExceeded || false,
            resetTime: action.payload.resetTime || null
          };
          break;
        case 'ADD_MESSAGE':
          next = { ...state, consulting: { ...state.consulting, messages: [...state.consulting.messages, action.payload] } };
          break;
        case 'SET_CONSULTING_STATE':
          next = { ...state, consulting: { ...state.consulting, state: action.payload.state, recommendations: action.payload.recommendations || state.consulting.recommendations, context: action.payload.context || state.consulting.context } };
          break;
        case 'SET_RECOMMENDATIONS':
          next = { ...state, consulting: { ...state.consulting, recommendations: action.payload } };
          break;
        case 'SET_PROJECT':
          next = { ...state, project: action.payload, stage: action.payload ? STAGES.PLANNING : state.stage };
          if (action.payload?.id) {
            localStorage.setItem('travelPMS_lastProjectId', action.payload.id);
          }
          break;
        case 'CLEAR_PROJECT':
          next = { ...state, project: null, itinerary: null };
          localStorage.removeItem('travelPMS_lastProjectId');
          break;
        case 'SET_ITINERARY':
          next = { ...state, itinerary: action.payload };
          break;
        case 'SET_USER_SETTINGS':
          next = { ...state, userSettings: { ...state.userSettings, ...action.payload } };
          break;
        case 'SET_PROJECT_WITH_ITINERARY':
          console.log('ğŸ”„ SET_PROJECT_WITH_ITINERARY ì‹¤í–‰:', action.payload);
          next = {
            ...state,
            project: action.payload.project,
            itinerary: action.payload.itinerary,
            stage: STAGES.PLANNING
          };
          console.log('ğŸ”„ ìƒˆë¡œìš´ state:', next);
          break;
        case 'UPDATE_TASK':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, tasks: state.project.tasks.map(t => t.id === action.payload.id ? { ...t, ...action.payload } : t) } };
          break;
        case 'UPDATE_BUDGET':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, budget: { ...state.project.budget, ...action.payload } } };
          break;
        case 'TOGGLE_TASK':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, tasks: state.project.tasks.map(t => t.id === action.payload.taskId ? { ...t, status: action.payload.status } : t) } };
          break;
        case 'SYNC_TASK':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, tasks: state.project.tasks.map(t => t.id === action.payload.taskId ? { ...t, status: action.payload.status } : t) } };
          break;
        case 'UPDATE_BUDGET_SPENT':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, budget: { ...state.project.budget, categories: { ...state.project.budget.categories, [action.payload.category]: { ...state.project.budget.categories[action.payload.category], spent: action.payload.spent } } } } };
          break;
        case 'SYNC_BUDGET':
          if (!state.project) return state;
          next = { ...state, project: { ...state.project, budget: { ...state.project.budget, categories: { ...state.project.budget.categories, [action.payload.category]: { ...state.project.budget.categories[action.payload.category], spent: action.payload.spent } } } } };
          break;
        case 'RESET':
          localStorage.removeItem('travelPMS_state');
          next = { ...initialState, consulting: { ...initialState.consulting, sessionId: `session-${Date.now()}` } };
          break;
        case 'GO_TO_SCREEN':
          next = { ...state, stage: action.payload };
          break;
        default:
          return state;
      }
      if (next.project) {
        localStorage.setItem('travelPMS_state', JSON.stringify(next));
      }
      return next;
    }

    // â”€â”€â”€ ìœ í‹¸ë¦¬í‹° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatCurrency(n) {
      if (n == null || isNaN(n)) return '0ì›';
      if (n >= 10000) return `${Math.round(n / 10000)}ë§Œì›`;
      return `${n.toLocaleString()}ì›`;
    }
    function formatUSD(n) {
      if (!n) return '';
      return `$${n.toLocaleString()}`;
    }

    function getDDay(dateStr) {
      if (!dateStr) return '';
      const diff = Math.ceil((new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24));
      return diff > 0 ? `D-${diff}` : diff === 0 ? 'D-Day' : `D+${Math.abs(diff)}`;
    }

    // â”€â”€â”€ ì•± ì»´í¬ë„ŒíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Socket.io ì—°ê²° (ì‹±ê¸€í†¤)
    const socketRef = { current: null };
    function getSocket() {
      if (!socketRef.current) {
        socketRef.current = io(API_BASE, { transports: ['websocket', 'polling'] });
      }
      return socketRef.current;
    }

    // â”€â”€â”€ PIN ì ê¸ˆ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const APP_PIN = '3512';  // PIN ì½”ë“œ ì„¤ì •
    const PIN_ENABLED = true;  // PIN ì ê¸ˆ í™œì„±í™”

    // â”€â”€â”€ PIN ê²Œì´íŠ¸ (App ë˜í¼) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function PinGate({ children }) {
      const [isUnlocked, setIsUnlocked] = useState(() =>
        !PIN_ENABLED || localStorage.getItem('travelPMS_unlocked') === 'true'
      );

      if (!isUnlocked) {
        return <PinLockScreen onUnlock={() => setIsUnlocked(true)} />;
      }
      return children;
    }

    // â”€â”€â”€ PIN ì ê¸ˆ í™”ë©´ ì»´í¬ë„ŒíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function PinLockScreen({ onUnlock }) {
      const [pin, setPin] = useState('');
      const [error, setError] = useState(false);
      const [shake, setShake] = useState(false);

      const handleKeyPress = (num) => {
        if (pin.length < 4) {
          const newPin = pin + num;
          setPin(newPin);
          setError(false);
          if (newPin.length === 4) {
            if (newPin === APP_PIN) {
              localStorage.setItem('travelPMS_unlocked', 'true');
              onUnlock();
            } else {
              setError(true);
              setShake(true);
              setTimeout(() => { setPin(''); setShake(false); }, 500);
            }
          }
        }
      };

      const handleDelete = () => {
        setPin(pin.slice(0, -1));
        setError(false);
      };

      return (
        <div className="fixed inset-0 bg-gradient-to-br from-primary-600 to-purple-700 flex items-center justify-center z-50">
          <div className="text-center">
            <div className="text-6xl mb-4">ğŸ”</div>
            <h1 className="text-white text-2xl font-bold mb-2">Travel PMS</h1>
            <p className="text-purple-200 text-sm mb-8">PINì„ ì…ë ¥í•˜ì„¸ìš”</p>

            {/* PIN í‘œì‹œ */}
            <div className={`flex justify-center gap-3 mb-8 ${shake ? 'animate-shake' : ''}`}>
              {[0, 1, 2, 3].map(i => (
                <div key={i} className={`w-4 h-4 rounded-full border-2 ${
                  pin.length > i
                    ? (error ? 'bg-red-400 border-red-400' : 'bg-white border-white')
                    : 'border-white/50'
                }`} />
              ))}
            </div>
            {error && <p className="text-red-300 text-sm mb-4">ì˜ëª»ëœ PINì…ë‹ˆë‹¤</p>}

            {/* ìˆ«ì í‚¤íŒ¨ë“œ */}
            <div className="grid grid-cols-3 gap-3 max-w-[240px] mx-auto">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, null, 0, 'del'].map((num, i) => (
                num === null ? <div key={i} /> :
                num === 'del' ? (
                  <button key={i} onClick={handleDelete} className="w-16 h-16 rounded-full bg-white/10 text-white text-xl flex items-center justify-center active:bg-white/20">
                    â†
                  </button>
                ) : (
                  <button key={i} onClick={() => handleKeyPress(num)} className="w-16 h-16 rounded-full bg-white/20 text-white text-2xl font-bold active:bg-white/30">
                    {num}
                  </button>
                )
              ))}
            </div>
          </div>
          <style>{`
            @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
            .animate-shake { animation: shake 0.3s ease-in-out; }
          `}</style>
        </div>
      );
    }

    function App() {
      const [state, dispatch] = useReducer(reducer, null, loadState);
      const [collabUsers, setCollabUsers] = useState([]);
      const [collabMessages, setCollabMessages] = useState([]);
      const [nickname, setNickname] = useState(() => localStorage.getItem('travelPMS_nickname') || '');

      useEffect(() => {
        let isMounted = true;

        api('/api/mode').then(data => {
          if (isMounted && data) dispatch({ type: 'SET_AI_MODE', payload: data });
        });

        // ì‹¤ì‹œê°„ í™˜ìœ¨ ë¡œë“œ
        api('/api/exchange-rates').then(data => {
          if (isMounted && data && data.rates) {
            window.__exchangeRates = data.rates;
            window.__exchangeRateProvider = data.provider;
            console.log('ğŸ’° ì‹¤ì‹œê°„ í™˜ìœ¨ ë¡œë“œ ì™„ë£Œ:', data.provider);
          }
        });

        // ê³µìœ  ë§í¬ë¡œ ì ‘ì†í•œ ê²½ìš°
        const params = new URLSearchParams(window.location.search);
        const sharedId = params.get('shared');
        if (sharedId) {
          api(`/api/share/${sharedId}`).then(data => {
            if (!isMounted) return;
            if (data && data.project) {
              dispatch({ type: 'SET_PROJECT', payload: data.project });
              if (data.itinerary) dispatch({ type: 'SET_ITINERARY', payload: data.itinerary });
            }
          });
        }

        // URL íŒŒë¼ë¯¸í„° ë˜ëŠ” localStorageì—ì„œ ë§ˆì§€ë§‰ í”„ë¡œì íŠ¸ ë³µì›
        const projectId = params.get('project') || localStorage.getItem('travelPMS_lastProjectId');
        if (projectId) {
          api(`/api/project/${projectId}`).then(data => {
            if (!isMounted) return;
            if (data && data.project) {
              dispatch({ type: 'SET_PROJECT', payload: data.project });
              if (data.itinerary) dispatch({ type: 'SET_ITINERARY', payload: data.itinerary });
            }
          });
        }

        return () => { isMounted = false; };
      }, []);

      // Socket.io ì‹¤ì‹œê°„ ë™ê¸°í™”
      useEffect(() => {
        if (!state.project?.id || !nickname) return;
        const socket = getSocket();
        let isSubscribed = true;

        socket.emit('project:join', { projectId: state.project.id, nickname });

        const handleProjectUsers = (users) => {
          if (isSubscribed) setCollabUsers(users);
        };

        const handleTaskUpdated = ({ taskId, status, updatedBy }) => {
          if (isSubscribed) dispatch({ type: 'SYNC_TASK', payload: { taskId, status, updatedBy } });
        };

        const handleBudgetUpdated = ({ category, spent, updatedBy }) => {
          if (isSubscribed) dispatch({ type: 'SYNC_BUDGET', payload: { category, spent, updatedBy } });
        };

        const handleItineraryUpdated = ({ itinerary, updatedBy }) => {
          if (isSubscribed) dispatch({ type: 'SET_ITINERARY', payload: itinerary });
        };

        const handleProjectUpdated = ({ project, itinerary }) => {
          if (!isSubscribed) return;
          if (project) dispatch({ type: 'SET_PROJECT', payload: project });
          if (itinerary) dispatch({ type: 'SET_ITINERARY', payload: itinerary });
        };

        const handleCollabMessage = (msg) => {
          if (isSubscribed) setCollabMessages(prev => [...prev.slice(-50), msg]);
        };

        socket.on('project:users', handleProjectUsers);
        socket.on('task:updated', handleTaskUpdated);
        socket.on('budget:updated', handleBudgetUpdated);
        socket.on('itinerary:updated', handleItineraryUpdated);
        socket.on('project:updated', handleProjectUpdated);
        socket.on('collab:message', handleCollabMessage);

        return () => {
          isSubscribed = false;
          socket.off('project:users', handleProjectUsers);
          socket.off('task:updated', handleTaskUpdated);
          socket.off('budget:updated', handleBudgetUpdated);
          socket.off('itinerary:updated', handleItineraryUpdated);
          socket.off('project:updated', handleProjectUpdated);
          socket.off('collab:message', handleCollabMessage);
          socket.emit('project:leave', { projectId: state.project.id });
        };
      }, [state.project?.id, nickname, dispatch]);

      // ìë™ ì €ì¥ í›… (2ì´ˆ ë””ë°”ìš´ì‹±)
      function useAutoSave(state, delay = 2000) {
        const saveTimeoutRef = useRef(null);
        const lastSavedRef = useRef(null);

        useEffect(() => {
          if (!state.project?.id) return;

          const currentState = JSON.stringify({
            project: state.project,
            itinerary: state.itinerary
          });

          if (lastSavedRef.current === currentState) return;

          if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

          saveTimeoutRef.current = setTimeout(async () => {
            try {
              const result = await api('/api/project/save', {
                method: 'POST',
                body: JSON.stringify({
                  projectId: state.project.id,
                  project: state.project,
                  itinerary: state.itinerary
                })
              });

              if (result?.ok) {
                lastSavedRef.current = currentState;
                console.log('âœ… ìë™ ì €ì¥:', new Date().toLocaleTimeString());
              }
            } catch (err) {
              console.error('âŒ ìë™ ì €ì¥ ì‹¤íŒ¨:', err);
            }
          }, delay);

          return () => {
            if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
          };
        }, [state.project, state.itinerary, delay]);
      }

      // ìë™ ì €ì¥ í™œì„±í™”
      useAutoSave(state);

      // ë‹‰ë„¤ì„ ì…ë ¥ (í”„ë¡œì íŠ¸ ì§„ì… ì‹œ)
      const saveNickname = (name) => {
        setNickname(name);
        localStorage.setItem('travelPMS_nickname', name);
      };

      // ë™ê¸°í™” í—¬í¼: ë³€ê²½ì‚¬í•­ì„ ì†Œì¼“ìœ¼ë¡œ ì „íŒŒ
      const syncDispatch = (action) => {
        dispatch(action);
        if (!state.project?.id) return;
        const socket = getSocket();
        if (action.type === 'TOGGLE_TASK') {
          socket.emit('task:update', { projectId: state.project.id, taskId: action.payload.taskId, status: action.payload.status, updatedBy: nickname });
        }
        if (action.type === 'UPDATE_BUDGET_SPENT') {
          socket.emit('budget:update', { projectId: state.project.id, category: action.payload.category, spent: action.payload.spent, updatedBy: nickname });
        }
      };

      const sendCollabMessage = (msg) => {
        if (!state.project?.id || !msg.trim()) return;
        getSocket().emit('collab:message', { projectId: state.project.id, message: msg, nickname });
      };

      const screens = {
        [STAGES.PROJECTS]: ProjectListScreen,
        [STAGES.CONSULTING]: ConsultingScreen,
        [STAGES.PLANNING]: DashboardScreen,
        [STAGES.EXECUTION]: DashboardScreen
      };
      const Screen = screens[state.stage];

      return (
        <div className="max-w-lg mx-auto min-h-screen bg-white shadow-xl relative">
          {/* ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ (í”„ë¡œì íŠ¸ ìˆê³  ë‹‰ë„¤ì„ ì—†ì„ ë•Œ) */}
          {state.project && !nickname && (
            <NicknameModal onSave={saveNickname} />
          )}
          <Screen state={state} dispatch={syncDispatch} collabUsers={collabUsers} collabMessages={collabMessages} sendCollabMessage={sendCollabMessage} nickname={nickname} />
        </div>
      );
    }

    // â”€â”€â”€ ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function NicknameModal({ onSave }) {
      const [name, setName] = useState('');
      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-xs shadow-xl">
            <h3 className="font-bold text-lg mb-2">í•¨ê»˜ ì—¬í–‰ ê³„íší•´ìš”!</h3>
            <p className="text-sm text-gray-500 mb-4">ë™í–‰ìì—ê²Œ ë³´ì—¬ì§ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
            <input value={name} onChange={e => setName(e.target.value)} placeholder="ì˜ˆ: ì—„ë§ˆ, ì•„ë¹ , ë‘˜ì§¸..."
              className="w-full border rounded-lg px-3 py-2 text-sm mb-3" autoFocus
              onKeyDown={e => { if (e.key === 'Enter' && name.trim()) onSave(name.trim()); }} />
            <button onClick={() => name.trim() && onSave(name.trim())} disabled={!name.trim()}
              className="w-full bg-primary-600 text-white py-2 rounded-lg text-sm font-medium disabled:opacity-50">
              ì‹œì‘í•˜ê¸°
            </button>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í™”ë©´ 0: í”„ë¡œì íŠ¸ ëª©ë¡
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ProjectListScreen({ state, dispatch }) {
      const [projects, setProjects] = useState([]);
      const [loading, setLoading] = useState(true);
      const [sortBy, setSortBy] = useState('updatedAt');
      const [sortOrder, setSortOrder] = useState('desc');
      const [filterConsulting, setFilterConsulting] = useState('all');
      const [showSettings, setShowSettings] = useState(false);

      useEffect(() => {
        let isMounted = true;

        const fetchProjects = async () => {
          setLoading(true);
          const data = await api('/api/projects');
          if (!isMounted) return;

          if (data?.projects) {
            let filtered = data.projects;

            // í•„í„°ë§
            if (filterConsulting === 'consulting') {
              filtered = filtered.filter(p => p.consultingContext);
            } else if (filterConsulting === 'direct') {
              filtered = filtered.filter(p => !p.consultingContext);
            }

            // ì •ë ¬
            filtered.sort((a, b) => {
              if (sortBy === 'title') {
                const aVal = a.destination?.name || a.title || '';
                const bVal = b.destination?.name || b.title || '';
                return sortOrder === 'asc'
                  ? aVal.localeCompare(bVal, 'ko')
                  : bVal.localeCompare(aVal, 'ko');
              }
              const aVal = new Date(a[sortBy]);
              const bVal = new Date(b[sortBy]);
              return sortOrder === 'desc' ? bVal - aVal : aVal - bVal;
            });

            setProjects(filtered);
          }
          setLoading(false);
        };

        fetchProjects();
        return () => { isMounted = false; };
      }, [sortBy, sortOrder, filterConsulting]);

      const selectProject = async (project) => {
        console.log('ğŸ” selectProject í˜¸ì¶œ:', project);

        // ì„œë²„ì—ì„œ ìµœì‹  í”„ë¡œì íŠ¸ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        const freshData = await api(`/api/project/${project.id}`);
        if (freshData && freshData.project) {
          console.log('âœ… ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ:', freshData.project);
          dispatch({
            type: 'SET_PROJECT_WITH_ITINERARY',
            payload: {
              project: freshData.project,
              itinerary: freshData.itinerary || null
            }
          });
        } else {
          // ì„œë²„ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©
          console.log('âš ï¸ ì„œë²„ ë¡œë“œ ì‹¤íŒ¨, ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©');
          dispatch({
            type: 'SET_PROJECT_WITH_ITINERARY',
            payload: {
              project,
              itinerary: project.itinerary || null
            }
          });
        }
      };

      const createNewProject = () => {
        dispatch({ type: 'RESET' });
        dispatch({ type: 'GO_TO_SCREEN', payload: STAGES.CONSULTING });
      };

      return (
        <div className="flex flex-col h-screen bg-gray-50">
          {/* í—¤ë” */}
          <div className="bg-gradient-to-r from-primary-600 to-purple-700 text-white px-4 py-4">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="font-bold text-xl">ğŸ“‚ ë‚´ ì—¬í–‰ í”„ë¡œì íŠ¸</h1>
                <p className="text-sm text-purple-100 mt-1">{projects.length}ê°œì˜ ì—¬í–‰ ê³„íš</p>
              </div>
              <button
                onClick={() => setShowSettings(true)}
                className="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-colors"
                title="ì„¤ì •"
              >
                âš™ï¸
              </button>
            </div>
          </div>

          {/* ì„¤ì • ëª¨ë‹¬ */}
          <SettingsModal
            isOpen={showSettings}
            onClose={() => setShowSettings(false)}
            state={state}
            dispatch={dispatch}
          />

          {/* ì •ë ¬/í•„í„° ë°” */}
          <div className="bg-white border-b px-4 py-3 space-y-2">
            <div className="flex gap-2 overflow-x-auto scrollbar-none">
              <FilterButton active={sortBy === 'updatedAt'} onClick={() => setSortBy('updatedAt')}>ìµœê·¼ ìˆ˜ì •ìˆœ</FilterButton>
              <FilterButton active={sortBy === 'createdAt'} onClick={() => setSortBy('createdAt')}>ìƒì„±ì¼ìˆœ</FilterButton>
              <FilterButton active={sortBy === 'title'} onClick={() => setSortBy('title')}>ì´ë¦„ìˆœ</FilterButton>
            </div>

            <div className="flex gap-2 overflow-x-auto scrollbar-none">
              <FilterChip active={filterConsulting === 'all'} onClick={() => setFilterConsulting('all')}>ì „ì²´</FilterChip>
              <FilterChip active={filterConsulting === 'consulting'} onClick={() => setFilterConsulting('consulting')}>ğŸ¤– AI ì»¨ì„¤íŒ…</FilterChip>
              <FilterChip active={filterConsulting === 'direct'} onClick={() => setFilterConsulting('direct')}>ì§ì ‘ ìƒì„±</FilterChip>
            </div>
          </div>

          {/* í”„ë¡œì íŠ¸ ëª©ë¡ */}
          <div className="flex-1 overflow-y-auto px-4 py-4 space-y-3">
            {loading ? (
              <div className="text-center py-12 text-gray-400">
                <div className="text-3xl mb-2">â³</div>
                <p>í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
            ) : projects.length === 0 ? (
              <div className="text-center py-12 text-gray-400">
                <div className="text-4xl mb-3">ğŸ§³</div>
                <p className="text-sm mb-4">ì•„ì§ ì—¬í–‰ ê³„íšì´ ì—†ì–´ìš”</p>
                <button onClick={createNewProject} className="bg-primary-600 text-white px-6 py-2 rounded-lg text-sm font-medium">
                  ì²« ì—¬í–‰ ê³„íš ë§Œë“¤ê¸°
                </button>
              </div>
            ) : (
              projects.map(project => (
                <ProjectCard
                  key={project.id}
                  project={project}
                  onClick={() => selectProject(project)}
                  onDelete={async (projectId) => {
                    const data = await api('/api/projects');
                    if (data?.projects) {
                      setProjects(data.projects);
                    }
                  }}
                />
              ))
            )}
          </div>

          {/* ìƒˆ í”„ë¡œì íŠ¸ ë²„íŠ¼ */}
          {projects.length > 0 && (
            <div className="p-4 bg-white border-t">
              <button onClick={createNewProject} className="w-full bg-primary-600 text-white py-3 rounded-lg font-medium">
                + ìƒˆ ì—¬í–‰ ê³„íš ë§Œë“¤ê¸°
              </button>
            </div>
          )}
        </div>
      );
    }

    function ProjectCard({ project, onClick, onDelete }) {
      const progress = project.tasks?.length > 0
        ? Math.round((project.tasks.filter(t => t.status === 'completed').length / project.tasks.length) * 100)
        : 0;

      const dDay = project.dates?.start ? getDDay(project.dates.start) : null;

      const totalSpent = project.budget?.categories
        ? Object.values(project.budget.categories).reduce((s, c) => s + (c.spent || 0), 0)
        : 0;
      const budgetUsage = project.budget?.total > 0
        ? Math.round((totalSpent / project.budget.total) * 100)
        : 0;

      const handleDelete = async (e) => {
        e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

        const projectName = project.destination?.name || project.title;
        if (!confirm(`"${projectName}" í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
          return;
        }

        try {
          const result = await api(`/api/project/${project.id}`, {
            method: 'DELETE'
          });

          if (result?.success) {
            console.log('âœ… í”„ë¡œì íŠ¸ ì‚­ì œ ì„±ê³µ:', project.id);
            if (onDelete) onDelete(project.id);
          }
        } catch (err) {
          console.error('âŒ í”„ë¡œì íŠ¸ ì‚­ì œ ì‹¤íŒ¨:', err);
          alert('í”„ë¡œì íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      };

      return (
        <div onClick={onClick} className="bg-white border rounded-xl p-4 cursor-pointer hover:shadow-md transition-shadow active:scale-98 relative">
          {/* ì‚­ì œ ë²„íŠ¼ */}
          <button
            onClick={handleDelete}
            className="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 transition-colors"
            title="í”„ë¡œì íŠ¸ ì‚­ì œ"
          >
            ğŸ—‘ï¸
          </button>

          <div className="flex items-start justify-between mb-2 pr-8">
            <div className="flex-1">
              <h3 className="font-bold text-lg flex items-center gap-2 flex-wrap">
                {project.destination?.flag} {project.destination?.name || project.title}
                {project.consultingContext && (
                  <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">ğŸ¤– AI</span>
                )}
              </h3>
              <p className="text-xs text-gray-500 mt-1">
                {new Date(project.updatedAt).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })} ìˆ˜ì •
              </p>
            </div>
            {dDay && (
              <div className="text-sm font-bold text-primary-600 bg-primary-50 px-3 py-1 rounded-lg whitespace-nowrap ml-2">
                {dDay}
              </div>
            )}
          </div>

          {/* ì§„í–‰ë¥  */}
          {project.tasks && project.tasks.length > 0 && (
            <div className="mb-2">
              <div className="flex justify-between text-xs text-gray-600 mb-1">
                <span>ì§„í–‰ë¥ </span>
                <span>{progress}%</span>
              </div>
              <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                <div className="h-full bg-primary-500 transition-all" style={{ width: `${progress}%` }} />
              </div>
            </div>
          )}

          {/* ì˜ˆì‚° */}
          {project.budget && (
            <div className="flex justify-between text-xs text-gray-600">
              <span>ì˜ˆì‚°</span>
              <span>
                {formatCurrency(totalSpent)} / {formatCurrency(project.budget.total)}
                <span className={budgetUsage > 90 ? 'text-red-500 ml-1' : 'text-gray-400 ml-1'}>
                  ({budgetUsage}%)
                </span>
              </span>
            </div>
          )}
        </div>
      );
    }

    // â”€â”€â”€ ì„¤ì • ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SettingsModal({ isOpen, onClose, state, dispatch }) {
      const [homeCity, setHomeCity] = useState(state.userSettings?.homeCity || 'ì„œìš¸');
      const [homeCountry, setHomeCountry] = useState(state.userSettings?.homeCountry || 'ëŒ€í•œë¯¼êµ­');
      const [defaultTravelers, setDefaultTravelers] = useState(state.userSettings?.defaultTravelers || 2);
      const [defaultBudget, setDefaultBudget] = useState(state.userSettings?.defaultBudget || 2000000);
      const [defaultDeparture, setDefaultDeparture] = useState(state.userSettings?.defaultDeparture || 'ICN');
      const [fuelEfficiency, setFuelEfficiency] = useState(state.userSettings?.fuelEfficiency || 10);
      const [fuelPrice, setFuelPrice] = useState(state.userSettings?.fuelPrice || 1700);

      const DEPARTURE_OPTIONS = [
        { id: 'ICN', name: 'ì¸ì²œ (ì¸ì²œê³µí•­)' }, { id: 'GMP', name: 'ì„œìš¸ (ê¹€í¬ê³µí•­)' },
        { id: 'PUS', name: 'ë¶€ì‚° (ê¹€í•´ê³µí•­)' }, { id: 'CJU', name: 'ì œì£¼ (ì œì£¼ê³µí•­)' },
        { id: 'TAE', name: 'ëŒ€êµ¬ (ëŒ€êµ¬ê³µí•­)' }, { id: 'KWJ', name: 'ê´‘ì£¼ (ê´‘ì£¼ê³µí•­)' },
        { id: 'CJJ', name: 'ì²­ì£¼ (ì²­ì£¼ê³µí•­)' }
      ];

      const handleSave = () => {
        dispatch({
          type: 'SET_USER_SETTINGS',
          payload: { homeCity, homeCountry, defaultTravelers: Number(defaultTravelers), defaultBudget: Number(defaultBudget), defaultDeparture, fuelEfficiency: Number(fuelEfficiency), fuelPrice: Number(fuelPrice) }
        });
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl max-w-md w-full p-6 max-h-[85vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-900">âš™ï¸ ì „ì—­ ì„¤ì •</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button>
            </div>
            <p className="text-xs text-gray-500 mb-4">ì—¬ê¸°ì„œ ì„¤ì •í•œ ê°’ì´ ìƒˆ í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤</p>

            <div className="space-y-4">
              {/* ê±°ì£¼ ì •ë³´ */}
              <div className="text-xs font-bold text-gray-500 uppercase tracking-wide">ğŸ  ê±°ì£¼ ì •ë³´</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê±°ì£¼ êµ­ê°€</label>
                  <input type="text" value={homeCountry} onChange={(e) => setHomeCountry(e.target.value)}
                    placeholder="ëŒ€í•œë¯¼êµ­" className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê±°ì£¼ ë„ì‹œ</label>
                  <input type="text" value={homeCity} onChange={(e) => setHomeCity(e.target.value)}
                    placeholder="ì„œìš¸" className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
                </div>
              </div>

              {/* ì—¬í–‰ ê¸°ë³¸ê°’ */}
              <div className="text-xs font-bold text-gray-500 uppercase tracking-wide pt-2">âœˆï¸ ì—¬í–‰ ê¸°ë³¸ê°’</div>
              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">ê¸°ë³¸ ì¶œë°œì§€</label>
                <select value={defaultDeparture} onChange={(e) => setDefaultDeparture(e.target.value)}
                  className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 bg-white">
                  {DEPARTURE_OPTIONS.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê¸°ë³¸ ì¸ì›ìˆ˜</label>
                  <div className="flex items-center gap-1">
                    <button onClick={() => setDefaultTravelers(Math.max(1, defaultTravelers - 1))}
                      className="w-8 h-8 rounded-lg border border-gray-300 text-gray-600 flex items-center justify-center hover:bg-gray-50">âˆ’</button>
                    <input type="number" min="1" max="99" value={defaultTravelers} onChange={(e) => setDefaultTravelers(Math.max(1, Number(e.target.value)))}
                      className="w-12 text-center text-sm border border-gray-300 rounded-lg py-1.5" />
                    <button onClick={() => setDefaultTravelers(Math.min(99, defaultTravelers + 1))}
                      className="w-8 h-8 rounded-lg border border-gray-300 text-gray-600 flex items-center justify-center hover:bg-gray-50">+</button>
                    <span className="text-xs text-gray-400">ëª…</span>
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ê¸°ë³¸ ì˜ˆì‚° (1ì¸)</label>
                  <div className="flex items-center gap-1">
                    <input type="number" min="0" step="100000" value={defaultBudget} onChange={(e) => setDefaultBudget(Number(e.target.value))}
                      className="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5" />
                    <span className="text-xs text-gray-400 whitespace-nowrap">ì›</span>
                  </div>
                </div>
              </div>

              {/* êµ­ë‚´ì—¬í–‰ ì°¨ëŸ‰ ì„¤ì • */}
              <div className="text-xs font-bold text-gray-500 uppercase tracking-wide pt-2">ğŸš— êµ­ë‚´ì—¬í–‰ ì°¨ëŸ‰</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ì—°ë¹„ (km/L)</label>
                  <input type="number" min="1" step="0.5" value={fuelEfficiency} onChange={(e) => setFuelEfficiency(Number(e.target.value))}
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">ìœ ê°€ (ì›/L)</label>
                  <input type="number" min="0" step="100" value={fuelPrice} onChange={(e) => setFuelPrice(Number(e.target.value))}
                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" />
                </div>
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button onClick={onClose}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">ì·¨ì†Œ</button>
              <button onClick={handleSave}
                className="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">ì €ì¥</button>
            </div>
          </div>
        </div>
      );
    }

    function FilterButton({ active, onClick, children }) {
      return (
        <button onClick={onClick} className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${active ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
          {children}
        </button>
      );
    }

    function FilterChip({ active, onClick, children }) {
      return (
        <button onClick={onClick} className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap border ${active ? 'border-primary-600 bg-primary-50 text-primary-700' : 'border-gray-300 bg-white text-gray-600'}`}>
          {children}
        </button>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í™”ë©´ 1: ëŒ€í™”í˜• ì»¨ì„¤íŒ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ConsultingScreen({ state, dispatch, collabUsers, collabMessages, sendCollabMessage, nickname }) {
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);
      const isInitializedRef = useRef(false);

      useEffect(() => {
        if (isInitializedRef.current) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

        if (state.consulting.messages.length === 0) {
          isInitializedRef.current = true;
          dispatch({
            type: 'ADD_MESSAGE',
            payload: {
              role: 'assistant',
              content: 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” **ì—¬í–‰ì´**, AI ì—¬í–‰ ì»¨ì„¤í„´íŠ¸ì˜ˆìš” âœˆï¸\n\nì–´ë–¤ ì—¬í–‰ì„ ê¿ˆê¾¸ê³  ê³„ì„¸ìš”?\në°”ë‹¤, ë„ì‹œ íƒí—˜, ë§›ì§‘ íˆ¬ì–´, ê°€ì¡± ì—¬í–‰... ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•´ ì£¼ì„¸ìš”! ğŸ˜Š',
              timestamp: new Date().toISOString(),
              provider: 'system'
            }
          });
        }
      }, [state.consulting.messages.length, dispatch]);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [state.consulting.messages]);

      const sendMessage = async () => {
        const msg = input.trim();
        if (!msg || loading) return;
        setInput('');
        setLoading(true);

        dispatch({ type: 'ADD_MESSAGE', payload: { role: 'user', content: msg, timestamp: new Date().toISOString() } });

        const result = await api('/api/chat', {
          method: 'POST',
          body: JSON.stringify({
            message: msg,
            sessionId: state.consulting.sessionId,
            userSettings: state.userSettings  // ê±°ì£¼ ë„ì‹œ ì •ë³´ ì „ë‹¬
          })
        });

        if (result) {
          dispatch({ type: 'ADD_MESSAGE', payload: { role: 'assistant', content: result.response, timestamp: new Date().toISOString(), provider: result.provider } });
          dispatch({ type: 'SET_CONSULTING_STATE', payload: { state: result.state, recommendations: result.recommendations, context: result.context } });
          if (result.recommendations && result.recommendations.length > 0) {
            dispatch({ type: 'SET_RECOMMENDATIONS', payload: result.recommendations });
          }
        } else {
          dispatch({ type: 'ADD_MESSAGE', payload: { role: 'assistant', content: 'ì£„ì†¡í•´ìš”, ì ì‹œ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì„¸ìš”! ğŸ™', timestamp: new Date().toISOString(), provider: 'error' } });
        }
        setLoading(false);
        inputRef.current?.focus();
      };

      const handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
      const handleInput = (e) => { e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px'; };

      const selectDestination = async (rec) => {
        setLoading(true);
        const travelerCount = state.consulting.context?.travelerCount || 2;
        const totalBudget = rec.estimatedCost * travelerCount;
        const result = await api('/api/project/create', {
          method: 'POST',
          body: JSON.stringify({
            destinationId: rec.id,
            sessionId: state.consulting.sessionId,
            budget: totalBudget,
            travelers: travelerCount,
            destinationData: rec  // AIê°€ ìƒì„±í•œ ëª©ì ì§€ ë°ì´í„° ì „ë‹¬
          })
        });
        if (result) {
          dispatch({ type: 'SET_PROJECT', payload: result });
          // ì¼ì • ìë™ ìƒì„±
          const itinerary = await api('/api/itinerary/generate', {
            method: 'POST',
            body: JSON.stringify({
              destinationId: rec.id,
              duration: result.destination?.sampleItinerary?.days || 4,
              travelers: result.travelers,
              budget: result.budget?.total,
              startDate: result.dates?.start,
              destinationData: rec
            })
          });
          if (itinerary) dispatch({ type: 'SET_ITINERARY', payload: itinerary });
        }
        setLoading(false);
      };

      return (
        <div className="flex flex-col h-screen">
          {/* í—¤ë” */}
          <div className="bg-gradient-to-r from-primary-600 to-purple-700 text-white px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="text-xl">ğŸ§³</span>
              <div>
                <h1 className="font-bold text-lg leading-tight">ì—¬í–‰ì´</h1>
                <p className="text-xs text-purple-200">AI ì—¬í–‰ ì»¨ì„¤í„´íŠ¸</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {state.aiMode !== 'unknown' && (
                <div className="flex flex-col items-end gap-0.5">
                  <span className={`text-sm font-semibold px-3 py-1 rounded-full border ${state.aiMode === 'gemini' ? 'bg-green-500/40 text-green-50 border-green-300/50' : 'bg-yellow-500/40 text-yellow-50 border-yellow-300/50'}`}>
                    {state.aiMode === 'gemini' ? 'ğŸ¤– Gemini AI' : state.quotaExceeded ? 'âš ï¸ Mock Mode' : 'ğŸ“‹ Demo'}
                  </span>
                  {state.quotaExceeded && state.resetTime && (
                    <span className="text-[10px] text-yellow-200 whitespace-nowrap">
                      {state.resetTime} ë¦¬ì…‹
                    </span>
                  )}
                </div>
              )}
              <button onClick={() => dispatch({ type: 'GO_TO_SCREEN', payload: STAGES.PROJECTS })}
                className="text-xs bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30">
                ğŸ“‚
              </button>
              {state.project && (
                <button onClick={() => dispatch({ type: 'GO_TO_SCREEN', payload: STAGES.PLANNING })}
                  className="text-xs bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30">
                  ğŸ“Š
                </button>
              )}
              <button onClick={() => setShowSettings(true)}
                className="text-xs bg-yellow-400/40 px-2 py-1 rounded-lg hover:bg-yellow-400/60 font-bold">
                âš™ï¸
              </button>
            </div>
          </div>

          {/* ì„¤ì • ëª¨ë‹¬ */}
          <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} state={state} dispatch={dispatch} />

          {/* ë©”ì‹œì§€ ì˜ì—­ */}
          <div className="flex-1 overflow-y-auto px-4 py-3 space-y-3">
            {state.consulting.messages.map((msg, i) => (
              <MessageBubble key={i} message={msg} />
            ))}

            {/* ì¶”ì²œ ì¹´ë“œ */}
            {state.consulting.recommendations && state.consulting.recommendations.length > 0 && !state.project && (
              <div className="space-y-2 slide-in">
                <p className="text-xs text-gray-500 text-center font-medium">ğŸ‘‡ ë§ˆìŒì— ë“œëŠ” ì—¬í–‰ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                {state.consulting.recommendations.map((rec, i) => (
                  <RecommendationCard key={rec.id} rec={rec} index={i} onSelect={selectDestination} disabled={loading} travelerCount={state.consulting.context?.travelerCount || 2} travelType={state.consulting.context?.travelType} />
                ))}
              </div>
            )}

            {loading && (
              <div className="flex items-start gap-2">
                <div className="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center text-sm">ğŸ¤–</div>
                <div className="bg-gray-100 rounded-2xl px-4 py-3">
                  <div className="flex gap-1"><span className="dot-pulse"></span><span className="dot-pulse" style={{animationDelay:'0.2s'}}></span><span className="dot-pulse" style={{animationDelay:'0.4s'}}></span></div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* ì…ë ¥ ì˜ì—­ */}
          <div className="border-t border-gray-200 px-4 py-3 bg-white">
            <div className="flex gap-2">
              <textarea ref={inputRef} value={input} onChange={e => setInput(e.target.value)}
                onKeyDown={handleKeyDown} onInput={handleInput} disabled={loading}
                rows={1}
                placeholder="ì—¬í–‰ ê³„íšì„ ììœ ë¡­ê²Œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”..."
                className="flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent disabled:bg-gray-50 resize-none overflow-hidden"
                style={{ minHeight: '42px', maxHeight: '120px' }}
              />
              <button onClick={sendMessage} disabled={loading || !input.trim()}
                className="bg-primary-600 text-white px-4 py-2.5 rounded-xl font-medium text-sm hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95">
                ì „ì†¡
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ë©”ì‹œì§€ ë²„ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function MessageBubble({ message }) {
      const isUser = message.role === 'user';

      // Provider ì •ë³´ë¥¼ ë¼ë²¨ë¡œ ë³€í™˜
      const getProviderLabel = (provider) => {
        if (!provider || provider === 'system') return null;
        const labels = {
          'gemini': { text: 'ğŸ¤– Gemini AI', color: 'bg-green-500/20 text-green-700' },
          'groq': { text: 'âš¡ Groq AI', color: 'bg-blue-500/20 text-blue-700' },
          'together': { text: 'ğŸŒ Together AI', color: 'bg-purple-500/20 text-purple-700' },
          'mock': { text: 'ğŸ“‹ Demo Mode', color: 'bg-yellow-500/20 text-yellow-700' },
          'error': { text: 'âš ï¸ Error', color: 'bg-red-500/20 text-red-700' }
        };
        return labels[provider] || { text: `ğŸ”§ ${provider}`, color: 'bg-gray-500/20 text-gray-700' };
      };

      const providerInfo = !isUser && message.provider ? getProviderLabel(message.provider) : null;

      return (
        <div className={`flex items-start gap-2 slide-in ${isUser ? 'flex-row-reverse' : ''}`}>
          {!isUser && <div className="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center text-sm flex-shrink-0">ğŸ¤–</div>}
          <div className="flex flex-col gap-1 max-w-[80%]">
            <div className={`rounded-2xl px-4 py-2.5 text-sm leading-relaxed whitespace-pre-wrap ${isUser ? 'bg-primary-600 text-white rounded-tr-md' : 'bg-gray-100 text-gray-800 rounded-tl-md'}`}>
              {message.content.split(/(\*\*.*?\*\*)/).map((part, i) =>
                part.startsWith('**') && part.endsWith('**')
                  ? <strong key={i}>{part.slice(2, -2)}</strong>
                  : part
              )}
            </div>
            {providerInfo && (
              <span className={`text-[10px] px-2 py-0.5 rounded self-start ${providerInfo.color}`}>
                {providerInfo.text}
              </span>
            )}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ì¶”ì²œ ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function RecommendationCard({ rec, index, onSelect, disabled, travelerCount, travelType }) {
      const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
      const count = travelerCount || 2;
      const isPackage = travelType === 'package';

      // í™˜ìœ¨ ìë™ ì ìš©: ì‹¤ì‹œê°„ í™˜ìœ¨ (ë°±ì—”ë“œì—ì„œ ë¡œë“œ) ë˜ëŠ” fallback
      const exchangeRates = window.__exchangeRates || { EUR: 1450, USD: 1350, GBP: 1700, AUD: 900, CNY: 190 };
      let rawCost = isPackage ? (rec.packageCost || Math.round(rec.estimatedCost * 0.8)) : rec.estimatedCost;

      // 10ë§Œì› ë¯¸ë§Œì´ê³  currencyê°€ ì™¸í™”ë©´ í™˜ìœ¨ ì ìš©
      if (rawCost < 100000 && rec.currency && exchangeRates[rec.currency]) {
        console.warn(`âš ï¸ ${rec.name}: estimatedCost ${rawCost.toLocaleString()}ê°€ ë„ˆë¬´ ì‘ìŒ. ${rec.currency}ë¡œ ê°„ì£¼í•˜ê³  í™˜ìœ¨ ì ìš©.`);
        rawCost = Math.round(rawCost * exchangeRates[rec.currency]);
      }

      const perCost = rawCost;
      const perCostUSD = isPackage ? (rec.packageCostUSD || null) : (rec.estimatedCostUSD || null);
      const totalCost = perCost * count;
      const typeLabel = isPackage ? 'íŒ¨í‚¤ì§€' : 'ììœ ì—¬í–‰';
      return (
        <button onClick={() => onSelect({...rec, estimatedCost: perCost})} disabled={disabled}
          className="w-full text-left bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-primary-400 hover:shadow-md transition-all active:scale-[0.98] disabled:opacity-50">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2">
              <span className="text-lg">{medals[index] || 'ğŸ¯'}</span>
              <span className="text-lg">{rec.flag}</span>
              <span className="font-bold text-gray-900">{rec.name}</span>
              <span className="text-xs text-gray-500">{rec.country}</span>
            </div>
            <span className="bg-primary-100 text-primary-700 text-xs font-bold px-2 py-0.5 rounded-full">
              {rec.matchScore}% ë§¤ì¹­
            </span>
          </div>
          <p className="text-xs text-gray-600 mb-2 line-clamp-2">{rec.reason}</p>
          <div className="flex gap-1 flex-wrap mb-2">
            {(rec.highlights || []).slice(0, 3).map((h, i) => (
              <span key={i} className="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{h}</span>
            ))}
          </div>
          <div className="flex items-center justify-between border-t pt-2">
            <span className={`text-[10px] px-1.5 py-0.5 rounded-full ${isPackage ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
              {typeLabel}
            </span>
            <div className="text-right">
              <span className="text-xs font-bold text-primary-600">
                1ì¸ {formatCurrency(perCost)}{perCostUSD ? ` (${formatUSD(perCostUSD)})` : ''}
              </span>
              <span className="block text-[10px] text-gray-400">
                {count}ì¸ ì´ {formatCurrency(totalCost)}
              </span>
            </div>
          </div>
        </button>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í™”ë©´ 2 & 3: í†µí•© ëŒ€ì‹œë³´ë“œ + ì¼ì •í‘œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function DashboardScreen({ state, dispatch, collabUsers, collabMessages, sendCollabMessage, nickname }) {
      const [activeTab, setActiveTab] = useState('overview');
      const [showSettings, setShowSettings] = useState(false);

      console.log('ğŸ“Š DashboardScreen ë Œë”ë§:', {
        hasProject: !!state.project,
        hasItinerary: !!state.itinerary,
        stage: state.stage,
        projectId: state.project?.id
      });

      if (!state.project) {
        console.log('âš ï¸ í”„ë¡œì íŠ¸ ì—†ìŒ - ë¡œë”© í™”ë©´ í‘œì‹œ');
        return (
          <div className="flex items-center justify-center h-screen bg-gradient-to-br from-primary-50 to-white">
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary-600 mb-6"></div>
              <p className="text-xl text-gray-700 font-medium">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              <p className="text-sm text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
          </div>
        );
      }

      console.log('âœ… í”„ë¡œì íŠ¸ ìˆìŒ - ëŒ€ì‹œë³´ë“œ ë Œë”ë§');
      const { project, itinerary } = state;

      // ë°ì´í„° ì•ˆì „ì„± ê²€ì‚¬ ë° ê¸°ë³¸ê°’ ì„¤ì •
      const tasks = project.tasks || [];
      const budget = project.budget || { total: 0, spent: 0, categories: {} };

      const completedTasks = tasks.filter(t => t.status === 'completed').length;
      const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
      const totalSpent = Object.values(budget.categories).reduce((s, c) => s + (c.spent || 0), 0);

      // budgetê³¼ tasks ë³€ìˆ˜ë¥¼ project ê°ì²´ì— ì¶”ê°€
      const safeProject = {
        ...project,
        tasks,
        budget
      };

      return (
        <div className="flex flex-col h-screen">
          {/* í—¤ë” */}
          <div className="bg-gradient-to-r from-primary-600 to-purple-700 text-white px-4 py-3">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <span className="text-xl">{project.destination?.flag || 'ğŸŒ'}</span>
                <div>
                  <h1 className="font-bold text-base leading-tight">{project.title}</h1>
                  <p className="text-xs text-purple-200">
                    {project.destination?.name || 'ì—¬í–‰ì§€'} {project.dates ? getDDay(project.dates.start) : ''}
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-1">
                {collabUsers && collabUsers.length > 0 && (
                  <span className="text-xs bg-green-500/30 text-green-100 px-2 py-1 rounded-lg">
                    ğŸ‘¥ {collabUsers.length}ëª… ì ‘ì†
                  </span>
                )}
                <button onClick={() => dispatch({ type: 'GO_TO_SCREEN', payload: STAGES.PROJECTS })}
                  className="text-xs bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30">ğŸ“‚</button>
                <button onClick={() => setShowSettings(true)}
                  className="text-xs bg-yellow-300 text-gray-800 px-2.5 py-1 rounded-lg hover:bg-yellow-400 font-bold shadow-sm">âš™ï¸ì„¤ì •</button>
                <button onClick={() => dispatch({ type: 'GO_TO_SCREEN', payload: STAGES.CONSULTING })}
                  className="text-xs bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30">ğŸ’¬</button>
                <button onClick={() => { if(confirm('ìƒˆ ì—¬í–‰ì„ ê³„íší• ê¹Œìš”?')) dispatch({ type: 'RESET' }); }}
                  className="text-xs bg-white/20 px-2 py-1 rounded-lg hover:bg-white/30">ğŸ”„</button>
              </div>
            </div>
            {/* ì§„í–‰ë¥  ë°” */}
            <div className="flex items-center gap-2">
              <div className="flex-1 bg-white/20 rounded-full h-2">
                <div className="bg-white rounded-full h-2 transition-all duration-500" style={{width: `${progress}%`}}></div>
              </div>
              <span className="text-xs font-bold">{progress}%</span>
            </div>
          </div>

          {/* ì„¤ì • ëª¨ë‹¬ */}
          <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} state={state} dispatch={dispatch} />

          {/* íƒ­ */}
          <div className="flex border-b border-gray-200 bg-white overflow-x-auto scrollbar-none">
            {[
              { id: 'overview', label: 'ğŸ“Š ì¡°ê²¬í‘œ' },
              { id: 'itinerary', label: 'ğŸ“… ì¼ì •í‘œ' },
              { id: 'simulator', label: 'ğŸ§® ì‹œë®¬' },
              { id: 'map', label: 'ğŸ—ºï¸ ì§€ë„' },
              { id: 'tasks', label: 'âœ… í• ì¼' },
              { id: 'budget', label: 'ğŸ’° ì˜ˆì‚°' },
              { id: 'emergency', label: 'ğŸ†˜ ë¹„ìƒ' },
              { id: 'share', label: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê³µìœ ' }
            ].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex-shrink-0 px-3 py-2.5 text-xs font-medium transition-all ${activeTab === tab.id ? 'text-primary-600 border-b-2 border-primary-600' : 'text-gray-500'}`}>
                {tab.label}
              </button>
            ))}
          </div>

          {/* íƒ­ ë‚´ìš© */}
          <div className="flex-1 overflow-y-auto">
            {activeTab === 'overview' && <OverviewTab project={safeProject} itinerary={itinerary} totalSpent={totalSpent} progress={progress} dispatch={dispatch} state={state} />}
            {activeTab === 'itinerary' && <ItineraryTab itinerary={itinerary} state={state} dispatch={dispatch} />}
            {activeTab === 'simulator' && <SimulatorTab project={safeProject} state={state} dispatch={dispatch} />}
            {activeTab === 'map' && <MapTab itinerary={itinerary} project={safeProject} />}
            {activeTab === 'tasks' && <TasksTab project={safeProject} dispatch={dispatch} />}
            {activeTab === 'budget' && <BudgetTab project={safeProject} totalSpent={totalSpent} dispatch={dispatch} />}
            {activeTab === 'emergency' && <EmergencyTab project={safeProject} />}
            {activeTab === 'share' && <ShareTab project={safeProject} itinerary={itinerary} state={state} />}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ì¡°ê²¬í‘œ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€â”€ ë‚ ì”¨ ìœ„ì ¯ ì»´í¬ë„ŒíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function WeatherWidget({ destName, startDate }) {
      const [weather, setWeather] = useState(null);
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        if (!destName) return;
        setLoading(true);
        const date = startDate || new Date().toISOString().split('T')[0];
        api(`/api/weather?dest=${encodeURIComponent(destName)}&date=${date}&days=7`).then(data => {
          if (data && data.forecast) setWeather(data);
          setLoading(false);
        }).catch(() => setLoading(false));
      }, [destName, startDate]);

      if (!destName || loading) return loading ? (
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 text-center">
          <p className="text-xs text-blue-500">ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ ë¡œë”© ì¤‘...</p>
        </div>
      ) : null;

      if (!weather || weather.error || !weather.forecast?.length) return null;

      return (
        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-3">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-bold text-blue-800">ğŸŒ¤ï¸ {destName} ë‚ ì”¨</h3>
            <span className="text-[10px] text-blue-400">
              {weather.isHistorical ? 'ì‘ë…„ ê¸°í›„ ì°¸ê³ ' : 'ì‹¤ì‹œê°„ ì˜ˆë³´'}
            </span>
          </div>
          <div className="flex gap-1.5 overflow-x-auto scrollbar-none pb-1">
            {weather.forecast.slice(0, 7).map((day, i) => (
              <div key={i} className="flex-shrink-0 text-center bg-white rounded-lg px-2 py-1.5 min-w-[52px] border border-blue-100">
                <p className="text-[10px] text-gray-500">{new Date(day.date).toLocaleDateString('ko', {month:'numeric',day:'numeric'})}</p>
                <p className="text-lg leading-tight">{day.icon}</p>
                <p className="text-[10px] font-bold text-gray-700">{day.tempMax}Â°</p>
                <p className="text-[10px] text-gray-400">{day.tempMin}Â°</p>
                {day.precipProbability != null && day.precipProbability > 30 && (
                  <p className="text-[10px] text-blue-500">ğŸ’§{day.precipProbability}%</p>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ë¹„ì ì •ë³´ ìœ„ì ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function VisaWidget({ country }) {
      const [visa, setVisa] = useState(null);

      useEffect(() => {
        if (!country || country === 'í•œêµ­' || country === 'ëŒ€í•œë¯¼êµ­') return;
        api(`/api/visa?country=${encodeURIComponent(country)}`).then(data => {
          if (data) setVisa(data);
        });
      }, [country]);

      if (!visa || !country || country === 'í•œêµ­' || country === 'ëŒ€í•œë¯¼êµ­') return null;

      const isRequired = visa.required;
      const bgColor = isRequired ? 'bg-amber-50 border-amber-200' : 'bg-green-50 border-green-200';
      const textColor = isRequired ? 'text-amber-700' : 'text-green-700';
      const badgeColor = isRequired ? 'bg-amber-100 text-amber-800' : 'bg-green-100 text-green-800';

      return (
        <div className={`${bgColor} border rounded-xl p-3`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="text-sm">ğŸ›‚</span>
              <span className={`text-sm font-bold ${textColor}`}>{country} ë¹„ì</span>
              <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${badgeColor}`}>
                {visa.type}
              </span>
            </div>
            <span className={`text-xs ${textColor}`}>{visa.duration}</span>
          </div>
          <p className="text-[10px] text-gray-500 mt-1">{visa.note}</p>
          {visa.link && (
            <a href={visa.link} target="_blank" rel="noopener noreferrer"
              className="text-[10px] text-blue-600 underline mt-1 inline-block">ì‹ ì²­ ë°”ë¡œê°€ê¸° â†’</a>
          )}
        </div>
      );
    }

    // ì¶œë°œì§€ ëª©ë¡
    const DEPARTURE_CITIES = [
      { id: 'ICN', name: 'ì¸ì²œ (ì¸ì²œê³µí•­)', airport: 'ICN' },
      { id: 'GMP', name: 'ì„œìš¸ (ê¹€í¬ê³µí•­)', airport: 'GMP' },
      { id: 'PUS', name: 'ë¶€ì‚° (ê¹€í•´ê³µí•­)', airport: 'PUS' },
      { id: 'CJU', name: 'ì œì£¼ (ì œì£¼ê³µí•­)', airport: 'CJU' },
      { id: 'TAE', name: 'ëŒ€êµ¬ (ëŒ€êµ¬ê³µí•­)', airport: 'TAE' },
      { id: 'KWJ', name: 'ê´‘ì£¼ (ê´‘ì£¼ê³µí•­)', airport: 'KWJ' },
      { id: 'CJJ', name: 'ì²­ì£¼ (ì²­ì£¼ê³µí•­)', airport: 'CJJ' }
    ];

    function OverviewTab({ project, itinerary, totalSpent, progress, dispatch, state }) {
      const tasks = project.tasks || [];
      const completedTasks = tasks.filter(t => t.status === 'completed').length;

      // ì—¬í–‰ ì¼ìˆ˜ ê³„ì‚°
      const calcNights = (start, end) => {
        if (!start || !end) return 0;
        const s = new Date(start);
        const e = new Date(end);
        return Math.ceil((e - s) / (1000 * 60 * 60 * 24));
      };

      const nights = calcNights(project.dates?.start, project.dates?.end);
      const days = nights + 1;

      // ë‚ ì§œ/ì¶œë°œì§€ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
      const updateDates = (field, value) => {
        const updated = {
          ...project,
          dates: { ...project.dates, [field]: value }
        };
        dispatch({ type: 'SET_PROJECT', payload: updated });
      };

      const updateDeparture = (departure) => {
        const updated = { ...project, departure };
        dispatch({ type: 'SET_PROJECT', payload: updated });
      };

      const updateTravelers = (count) => {
        const num = Math.max(1, Math.min(99, parseInt(count) || 1));
        const updated = { ...project, travelers: num };
        dispatch({ type: 'SET_PROJECT', payload: updated });
      };

      return (
        <div className="p-4 space-y-4">
          {/* ğŸ”§ ì—¬í–‰ ì„¤ì • ì¹´ë“œ */}
          <div className="bg-white border-2 border-orange-200 rounded-xl p-4">
            <h3 className="font-bold text-sm text-gray-900 mb-3 flex items-center gap-2">
              <span>âš™ï¸ ì—¬í–‰ ì„¤ì •</span>
              {nights > 0 && <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">{nights}ë°•{days}ì¼</span>}
            </h3>
            <div className="space-y-3">
              {/* ì¶œë°œì§€ */}
              <div className="flex items-center gap-2">
                <span className="text-xs text-gray-500 w-14">ì¶œë°œì§€</span>
                <select
                  value={project.departure || state.userSettings?.defaultDeparture || 'ICN'}
                  onChange={e => updateDeparture(e.target.value)}
                  className="flex-1 text-sm border border-gray-200 rounded-lg px-2 py-1.5 bg-white"
                >
                  {DEPARTURE_CITIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              {/* ì‹œì‘ì¼ */}
              <div className="flex items-center gap-2">
                <span className="text-xs text-gray-500 w-14">ì‹œì‘ì¼</span>
                <input
                  type="date"
                  value={project.dates?.start || ''}
                  onChange={e => updateDates('start', e.target.value)}
                  className="flex-1 text-sm border border-gray-200 rounded-lg px-2 py-1.5"
                />
              </div>
              {/* ì¢…ë£Œì¼ */}
              <div className="flex items-center gap-2">
                <span className="text-xs text-gray-500 w-14">ì¢…ë£Œì¼</span>
                <input
                  type="date"
                  value={project.dates?.end || ''}
                  onChange={e => updateDates('end', e.target.value)}
                  className="flex-1 text-sm border border-gray-200 rounded-lg px-2 py-1.5"
                />
              </div>
              {/* ì¸ì›ìˆ˜ */}
              <div className="flex items-center gap-2">
                <span className="text-xs text-gray-500 w-14">ì¸ì›ìˆ˜</span>
                <div className="flex-1 flex items-center gap-2">
                  <button
                    onClick={() => updateTravelers((project.travelers || state.userSettings?.defaultTravelers || 2) - 1)}
                    className="w-8 h-8 rounded-lg border border-gray-200 text-gray-600 text-lg flex items-center justify-center hover:bg-gray-50 active:bg-gray-100"
                  >âˆ’</button>
                  <input
                    type="number"
                    min="1"
                    max="99"
                    value={project.travelers || state.userSettings?.defaultTravelers || 2}
                    onChange={e => updateTravelers(e.target.value)}
                    className="w-14 text-center text-sm border border-gray-200 rounded-lg px-2 py-1.5"
                  />
                  <button
                    onClick={() => updateTravelers((project.travelers || state.userSettings?.defaultTravelers || 2) + 1)}
                    className="w-8 h-8 rounded-lg border border-gray-200 text-gray-600 text-lg flex items-center justify-center hover:bg-gray-50 active:bg-gray-100"
                  >+</button>
                  <span className="text-xs text-gray-400">ëª…</span>
                </div>
              </div>
              {(() => {
                const fhMap = {
                  'ë„ì¿„': 2.5, 'ì˜¤ì‚¬ì¹´': 2, 'í›„ì¿ ì˜¤ì¹´': 1.5, 'ì‚¿í¬ë¡œ': 3.5, 'ì˜¤í‚¤ë‚˜ì™€': 2.5, 'ë‚˜ê³ ì•¼': 2.5, 'êµí† ': 2,
                  'ë°©ì½•': 5.5, 'ë‹¤ë‚­': 4.5, 'í˜¸ì¹˜ë¯¼': 5.5, 'í•˜ë…¸ì´': 4.5, 'ë‚˜íŠ¸ë‘': 5, 'í‘¸ê¾¸ì˜¥': 5.5,
                  'ì‹±ê°€í¬ë¥´': 6.5, 'ë°œë¦¬': 7, 'ìì¹´ë¥´íƒ€': 7.5, 'ì„¸ë¶€': 4.5, 'ë§ˆë‹ë¼': 4, 'ë³´ë¼ì¹´ì´': 5,
                  'í¬ë¼ë¹„': 6, 'í‘¸ì¼“': 6, 'ì¹˜ì•™ë§ˆì´': 5.5, 'ì½”ì‚¬ë¬´ì´': 6,
                  'ì¿ ì•Œë¼ë£¸í‘¸ë¥´': 6.5, 'ë‘ì¹´ìœ„': 6.5, 'ì½”íƒ€í‚¤ë‚˜ë°œë£¨': 5.5,
                  'íƒ€ì´ë² ì´': 2.5, 'í™ì½©': 3.5, 'ë§ˆì¹´ì˜¤': 4, 'ìƒí•˜ì´': 2, 'ë² ì´ì§•': 2,
                  'ê´Œ': 4.5, 'ì‚¬ì´íŒ': 4.5, 'í•˜ì™€ì´': 9, 'í˜¸ë†€ë£°ë£¨': 9, 'ì˜¤ì•„í›„': 9, 'ë§ˆìš°ì´': 9.5, 'ë¹…ì•„ì¼ëœë“œ': 9.5,
                  'ë‰´ìš•': 14, 'LA': 12, 'ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤': 12, 'ìƒŒí”„ë€ì‹œìŠ¤ì½”': 11.5, 'ë¼ìŠ¤ë² ê°€ìŠ¤': 12, 'ì‹œì¹´ê³ ': 13, 'ì¹¸ì¿¤': 17, 'ë°´ì¿ ë²„': 10.5, 'í† ë¡ í† ': 13.5,
                  'íŒŒë¦¬': 12, 'ëŸ°ë˜': 12, 'ë¡œë§ˆ': 11.5, 'ë°”ë¥´ì…€ë¡œë‚˜': 12, 'ë§ˆë“œë¦¬ë“œ': 13,
                  'í”„ë¼í•˜': 11.5, 'ë¹ˆ': 11.5, 'ì·¨ë¦¬íˆ': 12, 'ì•”ìŠ¤í…Œë¥´ë‹´': 11.5, 'ë®Œí—¨': 11.5,
                  'ì´ìŠ¤íƒ„ë¶ˆ': 11, 'ì•„í…Œë„¤': 12, 'ë¦¬ìŠ¤ë³¸': 14, 'ë”ë¸”ë¦°': 13,
                  'ë¶€ë‹¤í˜ìŠ¤íŠ¸': 12, 'í—¬ì‹±í‚¤': 10, 'ìŠ¤í†¡í™€ë¦„': 11, 'ë² ë¥¼ë¦°': 11.5,
                  'ë°€ë¼ë…¸': 12, 'ë² ë„¤ì¹˜ì•„': 12, 'í”¼ë Œì²´': 12, 'ë‹ˆìŠ¤': 12.5,
                  'ë‘ë¸Œë¡œë¸Œë‹ˆí¬': 13, 'ì‚°í† ë¦¬ë‹ˆ': 13, 'ë ˆì´ìº¬ë¹„í¬': 14,
                  'ë‘ë°”ì´': 9.5, 'ëª°ë””ë¸Œ': 10, 'ì¹´ì´ë¡œ': 12, 'ì¼€ì´í”„íƒ€ìš´': 18,
                  'ì‹œë“œë‹ˆ': 10.5, 'ë©œë²„ë¥¸': 11, 'ì˜¤í´ëœë“œ': 11.5, 'í€¸ìŠ¤íƒ€ìš´': 13, 'í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜': 12, 'í”¼ì§€': 11,
                  'ì œì£¼': 1, 'ì œì£¼ë„': 1, 'ë¶€ì‚°': 0
                };
                const destName = project.destination?.name;
                const fh = fhMap[destName];
                const fhText = fh != null ? (fh === 0 ? null : fh % 1 === 0 ? `${fh}ì‹œê°„` : `${Math.floor(fh)}ì‹œê°„ ${Math.round((fh % 1) * 60)}ë¶„`) : null;
                const departure = DEPARTURE_CITIES.find(c => c.id === (project.departure || state.userSettings?.defaultDeparture || 'ICN'))?.name;
                return (
                  <div className="text-xs text-center text-orange-600 font-medium pt-1">
                    <div>âœˆï¸ {departure} â†’ {destName} {nights > 0 ? `(${nights}ë°•${days}ì¼)` : ''}</div>
                    {fhText && <div className="text-[10px] text-gray-400 mt-0.5">í¸ë„ ì†Œìš”ì‹œê°„ ì•½ {fhText}</div>}
                  </div>
                );
              })()}
            </div>
          </div>

          {/* ë‚ ì”¨ ìœ„ì ¯ */}
          <WeatherWidget destName={project.destination?.name} startDate={project.dates?.start} />

          {/* ë¹„ì ì •ë³´ */}
          <VisaWidget country={project.destination?.country} />

          {/* í•µì‹¬ ìš”ì•½ ì¹´ë“œ */}
          <div className="bg-gradient-to-br from-primary-500 to-purple-600 text-white rounded-2xl p-4">
            <div className="grid grid-cols-3 gap-3 text-center">
              <div>
                <p className="text-2xl font-bold">{project.dates ? getDDay(project.dates.start) : 'D-?'}</p>
                <p className="text-xs text-purple-200">ì¶œë°œê¹Œì§€</p>
              </div>
              <div>
                <p className="text-2xl font-bold">{progress}%</p>
                <p className="text-xs text-purple-200">ì¤€ë¹„ ì™„ë£Œ</p>
              </div>
              <div>
                <p className="text-2xl font-bold">{formatCurrency(totalSpent)}</p>
                <p className="text-xs text-purple-200">ì‚¬ìš© ê¸ˆì•¡</p>
              </div>
            </div>
          </div>

          {/* íƒ€ì„ë¼ì¸ */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h3 className="font-bold text-sm text-gray-900 mb-3">ğŸ“‹ ì¤€ë¹„ íƒ€ì„ë¼ì¸</h3>
            <div className="space-y-3">
              {project.milestones.map((m, i) => (
                <div key={m.id} className="flex items-center gap-3">
                  <div className={`w-3 h-3 rounded-full flex-shrink-0 ${m.status === 'completed' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                  <div className="flex-1 flex items-center justify-between">
                    <span className={`text-sm ${m.status === 'completed' ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{m.label}</span>
                    <span className="text-xs text-gray-400">{m.id.toUpperCase()}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* ì¼ì • ìš”ì•½ */}
          {itinerary && (
            <div className="bg-white border border-gray-200 rounded-xl p-4">
              <h3 className="font-bold text-sm text-gray-900 mb-3">ğŸ“… ì¼ì • ìš”ì•½</h3>
              <div className="space-y-2">
                {itinerary.days.map(day => (
                  <div key={day.dayNumber} className="flex items-center gap-2 text-sm">
                    <span className="bg-primary-100 text-primary-700 text-xs font-bold px-2 py-0.5 rounded w-12 text-center">Day{day.dayNumber}</span>
                    <span className="text-gray-800 flex-1 truncate">{day.title}</span>
                    <span className="text-xs text-gray-400">{formatCurrency(day.totalCost)}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ì˜ˆì•½ í˜„í™© */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h3 className="font-bold text-sm text-gray-900 mb-3">ğŸ« ì˜ˆì•½ í˜„í™©</h3>
            <div className="space-y-2">
              {project.tasks.slice(0, 4).map(task => (
                <div key={task.id} className="flex items-center justify-between text-sm">
                  <div className="flex items-center gap-2">
                    <span>{task.status === 'completed' ? 'âœ…' : 'â³'}</span>
                    <span className={task.status === 'completed' ? 'text-gray-500' : 'text-gray-800'}>{task.title}</span>
                  </div>
                  {task.estimatedCost > 0 && (
                    <span className="text-xs text-gray-500">{formatCurrency(task.estimatedCost)}</span>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* ì˜ˆì‚° ë°°ë¶„ ë¯¸ë‹ˆ */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-sm text-gray-900">ğŸ’° ì˜ˆì‚° ë°°ë¶„</h3>
              <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">ì´ {project.travelers}ëª…</span>
            </div>
            <div className="space-y-2">
              {Object.entries(project.budget.categories).map(([cat, data]) => (
                <div key={cat} className="space-y-1">
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-700">{cat}</span>
                    <span className="text-gray-500">{formatCurrency(data.spent)} / {formatCurrency(data.budget)}</span>
                  </div>
                  <div className="bg-gray-100 rounded-full h-2">
                    <div className="bg-primary-500 rounded-full h-2 transition-all"
                      style={{width: `${data.budget > 0 ? Math.min((data.spent / data.budget) * 100, 100) : 0}%`}}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ìŠ¬ë¡¯ ìƒì„¸ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SlotDetailModal({ slot, destName, isOpen, onClose }) {
      if (!isOpen || !slot || !slot.detail) return null;
      const detail = slot.detail;

      const typeColors = {
        food: { bg: 'bg-orange-50', accent: 'text-orange-600', badge: 'bg-orange-100 text-orange-700' },
        activity: { bg: 'bg-green-50', accent: 'text-green-600', badge: 'bg-green-100 text-green-700' },
        hotel: { bg: 'bg-purple-50', accent: 'text-purple-600', badge: 'bg-purple-100 text-purple-700' },
        shopping: { bg: 'bg-pink-50', accent: 'text-pink-600', badge: 'bg-pink-100 text-pink-700' }
      };
      const colors = typeColors[slot.type] || { bg: 'bg-gray-50', accent: 'text-gray-600', badge: 'bg-gray-100 text-gray-700' };

      const renderStars = (rating) => {
        if (!rating) return null;
        const full = Math.floor(rating);
        const half = rating % 1 >= 0.5;
        return (
          <span className="text-yellow-500 text-xs">
            {'â˜…'.repeat(full)}{half ? 'Â½' : ''}
            <span className="text-gray-300">{'â˜…'.repeat(5 - full - (half ? 1 : 0))}</span>
            <span className="text-gray-500 ml-1">{rating}</span>
          </span>
        );
      };

      return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center" onClick={onClose}>
          {/* ë°°ê²½ ì˜¤ë²„ë ˆì´ */}
          <div className="absolute inset-0 bg-black/50 transition-opacity"></div>
          {/* ëª¨ë‹¬ ë³¸ì²´ - ë°”í…€ì‹œíŠ¸ (ëª¨ë°”ì¼) / ì„¼í„° ëª¨ë‹¬ (ë°ìŠ¤í¬í†±) */}
          <div className="relative w-full sm:max-w-lg bg-white sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-hidden flex flex-col slide-up-modal"
               onClick={(e) => e.stopPropagation()}>
            {/* ëª¨ë°”ì¼ í•¸ë“¤ */}
            <div className="sm:hidden flex justify-center pt-2 pb-1">
              <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
            </div>

            {/* í—¤ë” */}
            <div className={`px-5 py-4 ${colors.bg} border-b border-gray-100`}>
              <div className="flex items-start justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-2xl">{slot.icon}</span>
                  <div>
                    <h3 className="font-bold text-gray-900 text-base">{slot.title}</h3>
                    <div className="flex items-center gap-2 mt-0.5">
                      <span className="text-xs text-gray-500">{slot.time}</span>
                      <span className="text-xs text-gray-400">Â·</span>
                      <span className="text-xs text-gray-500">ğŸ“ {slot.location}</span>
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-1">âœ•</button>
              </div>
              {slot.cost > 0 && (
                <div className="mt-2">
                  <span className={`text-sm font-bold ${colors.accent}`}>ğŸ’° {slot.cost.toLocaleString()}ì›</span>
                </div>
              )}
            </div>

            {/* ìŠ¤í¬ë¡¤ ì½˜í…ì¸  */}
            <div className="overflow-y-auto flex-1 px-5 py-4 space-y-4">
              {/* ì„¤ëª… */}
              {detail.description && (
                <p className="text-sm text-gray-700 leading-relaxed">{detail.description}</p>
              )}

              {/* ë°°ì§€ (ì†Œìš”ì‹œê°„, ì˜ˆì•½í•„ìš”, ì•„ì´ë™ë°˜) */}
              <div className="flex flex-wrap gap-2">
                {detail.duration && (
                  <span className="inline-flex items-center gap-1 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">â± {detail.duration}</span>
                )}
                {detail.reservationNeeded && (
                  <span className="inline-flex items-center gap-1 text-xs bg-red-50 text-red-600 px-2 py-1 rounded-full">ğŸ“ ì˜ˆì•½ í•„ìš”</span>
                )}
                {detail.reservationNeeded === false && (
                  <span className="inline-flex items-center gap-1 text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full">ğŸš¶ ì˜ˆì•½ ë¶ˆí•„ìš”</span>
                )}
                {detail.childFriendly === true && (
                  <span className="inline-flex items-center gap-1 text-xs bg-green-50 text-green-600 px-2 py-1 rounded-full">ğŸ‘¶ ì•„ì´ ë™ë°˜ OK</span>
                )}
                {detail.childFriendly === false && (
                  <span className="inline-flex items-center gap-1 text-xs bg-yellow-50 text-yellow-600 px-2 py-1 rounded-full">âš ï¸ ì•„ì´ ë¹„ì¶”ì²œ</span>
                )}
              </div>

              {/* ì¶”ì²œ ì„ íƒì§€ */}
              {detail.options && detail.options.length > 0 && (
                <div>
                  <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">âœ¨ ì¶”ì²œ {detail.options.length}ê³³</h4>
                  <div className="space-y-2.5">
                    {detail.options.map((opt, idx) => (
                      <div key={idx} className="bg-white border border-gray-200 rounded-xl p-3 hover:shadow-sm transition-shadow">
                        <div className="flex items-start justify-between">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="font-semibold text-sm text-gray-900">{idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'} {opt.name}</span>
                            </div>
                            <div className="flex items-center gap-2 mt-1">
                              {opt.category && <span className={`text-[10px] px-1.5 py-0.5 rounded ${colors.badge}`}>{opt.category}</span>}
                              {renderStars(opt.rating)}
                            </div>
                          </div>
                          {opt.priceRange && (
                            <span className="text-xs text-gray-500 flex-shrink-0 ml-2">{opt.priceRange}</span>
                          )}
                        </div>
                        {/* í•˜ì´ë¼ì´íŠ¸ íƒœê·¸ */}
                        {opt.highlights && opt.highlights.length > 0 && (
                          <div className="flex flex-wrap gap-1 mt-2">
                            {opt.highlights.map((h, hi) => (
                              <span key={hi} className="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full">{h}</span>
                            ))}
                          </div>
                        )}
                        {/* ì¶”ì²œ ì‚¬ìœ  */}
                        {opt.reason && (
                          <p className="text-xs text-gray-500 mt-1.5 leading-relaxed">ğŸ’¡ {opt.reason}</p>
                        )}
                        {/* ì§€ë„ ë§í¬ */}
                        {opt.mapQuery && (
                          <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(opt.mapQuery)}`}
                             target="_blank" rel="noopener noreferrer"
                             className="inline-flex items-center gap-1 text-[11px] text-blue-500 hover:text-blue-700 mt-1.5">
                            ğŸ“ ì§€ë„ì—ì„œ ë³´ê¸°
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ì‹¤ìš© íŒ */}
              {detail.tips && detail.tips.length > 0 && (
                <div className="bg-amber-50 rounded-xl p-3">
                  <h4 className="text-xs font-bold text-amber-700 mb-1.5">ğŸ’¡ ì‹¤ìš© íŒ</h4>
                  <ul className="space-y-1">
                    {detail.tips.map((tip, ti) => (
                      <li key={ti} className="text-xs text-amber-800 flex items-start gap-1.5">
                        <span className="text-amber-500 mt-0.5">â€¢</span>{tip}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* í•˜ë‹¨ ë²„íŠ¼ */}
            <div className="px-5 py-3 border-t border-gray-100 flex gap-2 bg-white">
              <a href={`https://www.google.com/search?q=${encodeURIComponent(slot.title + ' ' + (destName || slot.location))}`}
                 target="_blank" rel="noopener noreferrer"
                 className="flex-1 text-center py-2.5 bg-gray-100 text-gray-700 rounded-xl text-sm font-medium hover:bg-gray-200 transition-colors">
                ğŸ” Google ê²€ìƒ‰
              </a>
              <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(slot.title + ' ' + (destName || slot.location))}`}
                 target="_blank" rel="noopener noreferrer"
                 className="flex-1 text-center py-2.5 bg-primary-600 text-white rounded-xl text-sm font-medium hover:bg-primary-700 transition-colors">
                ğŸ—ºï¸ ì§€ë„ ë³´ê¸°
              </a>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ì¼ì •í‘œ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ItineraryTab({ itinerary, state, dispatch }) {
      const [activeDay, setActiveDay] = useState(1);
      const [regenerating, setRegenerating] = useState(false);
      const [selectedSlot, setSelectedSlot] = useState(null);

      if (!itinerary) {
        return (
          <div className="p-8 text-center text-gray-500">
            <p className="text-4xl mb-2">ğŸ“…</p>
            <p className="text-sm">ì¼ì •ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ì–´ìš”</p>
            <button onClick={async () => {
              if (!state.project) return;
              setRegenerating(true);
              // ë‚ ì§œ ê¸°ë°˜ ì¼ìˆ˜ ê³„ì‚° (ì—†ìœ¼ë©´ ê¸°ë³¸ 4ì¼)
              const calcDays = (start, end) => {
                if (!start || !end) return 4;
                const s = new Date(start);
                const e = new Date(end);
                return Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
              };
              const duration = calcDays(state.project.dates?.start, state.project.dates?.end);
              const result = await api('/api/itinerary/generate', {
                method: 'POST',
                body: JSON.stringify({
                  destinationId: state.project.destination.id,
                  duration: duration,
                  travelers: state.project.travelers,
                  budget: state.project.budget.total,
                  departure: state.project.departure || 'ICN',
                  startDate: state.project.dates?.start
                })
              });
              if (result) dispatch({ type: 'SET_ITINERARY', payload: result });
              setRegenerating(false);
            }} className="mt-3 bg-primary-600 text-white px-4 py-2 rounded-lg text-sm">
              {regenerating ? 'ìƒì„± ì¤‘...' : 'ğŸ¤– AIë¡œ ì¼ì • ìƒì„±'}
            </button>
          </div>
        );
      }

      const rawDay = itinerary.days.find(d => d.dayNumber === activeDay) || itinerary.days[0];
      const totalDays = itinerary.days.length;
      const travelers = state.project?.travelers || 1;

      // í¸ë„ í•­ê³µë¹„ ê³„ì‚° (ì™•ë³µì˜ ì ˆë°˜)
      const destName = state.project?.destination?.name || '';

      // detailì´ ì—†ëŠ” food/activity/hotel ìŠ¬ë¡¯ì— ìë™ ê¸°ë³¸ detail ìƒì„±
      const enrichSlotDetail = (slot) => {
        if (slot.detail) return slot;
        const genericWords = ['í˜¸í…”', 'ê³µí•­', 'ì¡°ì‹', 'ì ì‹¬', 'ì €ë…', 'ì¶œë°œ', 'ê·€êµ­', 'ë„ì°©', 'ì²´í¬ì¸', 'ì²´í¬ì•„ì›ƒ', 'ì´ë™', 'íœ´ì‹', 'ììœ ì‹œê°„', 'í˜¸í…” ì¡°ì‹', 'í¸ì˜ì ', 'ë©´ì„¸ì '];
        const isGeneric = genericWords.some(w => slot.title === w || slot.title?.includes('ë§ˆì§€ë§‰'));
        if (isGeneric) return slot;
        if (slot.type === 'food' && slot.title) {
          return { ...slot, detail: {
            description: `${destName || slot.location}ì—ì„œ ì¦ê¸°ëŠ” ${slot.title}`,
            options: [{ name: slot.title, category: slot.type === 'food' ? 'ë§›ì§‘' : '', priceRange: slot.cost > 0 ? `ì•½ ${slot.cost.toLocaleString()}ì›` : 'ê°€ê²© ë¯¸ì •', rating: null, highlights: slot.notes ? [slot.notes] : [], reason: `${slot.location} í˜„ì§€ ì¶”ì²œ ë§›ì§‘`, mapQuery: `${slot.title} ${slot.location || destName}` }],
            tips: slot.notes ? [slot.notes] : [],
            duration: 'ì•½ 30~60ë¶„',
            reservationNeeded: false,
            childFriendly: true
          }};
        }
        if (slot.type === 'activity' && slot.title) {
          return { ...slot, detail: {
            description: `${slot.title} - ${slot.location || destName}`,
            options: [{ name: slot.title, category: 'ê´€ê´‘', priceRange: slot.cost > 0 ? `ì•½ ${slot.cost.toLocaleString()}ì›` : 'ë¬´ë£Œ', rating: null, highlights: slot.notes ? [slot.notes] : [], reason: `${destName} ì—¬í–‰ ì¶”ì²œ ëª…ì†Œ`, mapQuery: `${slot.title} ${slot.location || destName}` }],
            tips: slot.notes ? [slot.notes] : [],
            duration: 'ì•½ 1~2ì‹œê°„',
            reservationNeeded: false,
            childFriendly: true
          }};
        }
        if (slot.type === 'hotel' && slot.title) {
          return { ...slot, detail: {
            description: `${slot.location || destName} ìˆ™ì†Œ`,
            options: [{ name: slot.title, category: 'ìˆ™ì†Œ', priceRange: slot.cost > 0 ? `1ë°• ì•½ ${slot.cost.toLocaleString()}ì›` : 'ê°€ê²© ë¯¸ì •', rating: null, highlights: slot.notes ? [slot.notes] : [], reason: `${slot.location || destName} ì¶”ì²œ ìˆ™ì†Œ`, mapQuery: `${slot.title} ${slot.location || destName}` }],
            tips: slot.notes ? [slot.notes] : [],
            duration: '',
            reservationNeeded: true,
            childFriendly: true
          }};
        }
        return slot;
      };

      const day = { ...rawDay, slots: rawDay.slots.map(enrichSlotDetail) };
      // ë„ì‹œëª… ë³„ì¹­ ë§¤ì¹­
      const itinCityAliases = {
        'í˜¸ë†€ë£°ë£¨': 'í•˜ì™€ì´', 'ì™€ì´í‚¤í‚¤': 'í•˜ì™€ì´', 'ì˜¤ì•„í›„': 'í•˜ì™€ì´', 'ë§ˆìš°ì´': 'í•˜ì™€ì´', 'ë¹…ì•„ì¼ëœë“œ': 'í•˜ì™€ì´', 'ì¹´ìš°ì•„ì´': 'í•˜ì™€ì´',
        'ë™ê²½': 'ë„ì¿„',
        'íƒ€ì´í˜ì´': 'íƒ€ì´ë² ì´', 'ëŒ€ë§Œ': 'íƒ€ì´ë² ì´', 'ì‚¬ì´ê³µ': 'í˜¸ì¹˜ë¯¼',
        'ë´íŒŒì‚¬ë¥´': 'ë°œë¦¬', 'ìš°ë¶“': 'ë°œë¦¬', 'ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤': 'LA', 'ì—˜ì—ì´': 'LA',
        'ë¹„ì—”ë‚˜': 'ë¹ˆ', 'í”„ë¼í•˜': 'í”„ë¼í•˜', 'í¬ë¼ë¹„': 'í¬ë¼ë¹„', 'í‘¸ì¼“': 'í‘¸ì¼“',
        'ì´ìŠ¤íƒ„ë¶ˆ': 'ì´ìŠ¤íƒ„ë¶ˆ', 'ì•™ì¹´ë¼': 'ì´ìŠ¤íƒ„ë¶ˆ',
        'ë‚˜í•˜': 'ì˜¤í‚¤ë‚˜ì™€', 'ì„¸ë¶€ì‹œí‹°': 'ì„¸ë¶€', 'ë§‰íƒ„': 'ì„¸ë¶€',
        'í˜¸ì´ì•ˆ': 'ë‹¤ë‚­', 'í›„ì—': 'ë‹¤ë‚­'
      };
      const itinDestName = itinCityAliases[destName] || destName;
      const flightRoundtripMap = {
        'ë„ì¿„': 600000, 'ì˜¤ì‚¬ì¹´': 550000, 'í›„ì¿ ì˜¤ì¹´': 450000, 'ì‚¿í¬ë¡œ': 650000, 'ì˜¤í‚¤ë‚˜ì™€': 600000,
        'ë°©ì½•': 700000, 'ë‹¤ë‚­': 600000, 'í˜¸ì¹˜ë¯¼': 650000, 'ë‚˜íŠ¸ë‘': 650000,
        'ì‹±ê°€í¬ë¥´': 800000, 'ë°œë¦¬': 900000, 'ì„¸ë¶€': 550000,
        'í¬ë¼ë¹„': 800000, 'í‘¸ì¼“': 800000,
        'íƒ€ì´ë² ì´': 500000, 'í™ì½©': 550000,
        'ê´Œ': 800000, 'ì‚¬ì´íŒ': 850000, 'í•˜ì™€ì´': 1800000,
        'ë‰´ìš•': 2200000, 'LA': 1800000, 'ì¹¸ì¿¤': 2500000,
        'íŒŒë¦¬': 1800000, 'ëŸ°ë˜': 1800000, 'ë¡œë§ˆ': 1700000, 'ë°”ë¥´ì…€ë¡œë‚˜': 1700000,
        'ì´ìŠ¤íƒ„ë¶ˆ': 1400000,
        'í”„ë¼í•˜': 1600000, 'ë¹ˆ': 1700000, 'ì·¨ë¦¬íˆ': 1900000, 'ì•”ìŠ¤í…Œë¥´ë‹´': 1700000,
        'ì‹œë“œë‹ˆ': 1500000, 'ëª°ë””ë¸Œ': 2000000,
        'ì œì£¼ë„': 200000
      };
      const roundtripPrice = flightRoundtripMap[itinDestName];
      const oneWayFlight = roundtripPrice ? Math.round(roundtripPrice / 2) : 0;

      // Dayë³„ ì´ ë¹„ìš© ê³„ì‚° (í•­ê³µë¹„ í¬í•¨)
      const getDayCost = (d) => {
        let base = d.totalCost || 0;
        if (d.dayNumber === 1 && oneWayFlight > 0) base += oneWayFlight;
        if (d.dayNumber === totalDays && oneWayFlight > 0) base += oneWayFlight;
        return base;
      };

      const regenerateItinerary = async () => {
        if (!state.project || !state.project.destination) {
          alert('ëª©ì ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        setRegenerating(true);
        try {
          const destId = state.project.destination.id || state.project.destination.name;
          const dates = state.project.dates || {};
          // ì„¤ì • ë‚ ì§œ ê¸°ë°˜ ì¼ìˆ˜ ê³„ì‚°
          let calcDuration = itinerary.days.length;
          if (dates.start && dates.end) {
            const s = new Date(dates.start);
            const e = new Date(dates.end);
            calcDuration = Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
          }
          console.log('ğŸ”„ AI ì¼ì • ì¬ìƒì„±:', { destId, duration: calcDuration, startDate: dates.start });

          const result = await api('/api/itinerary/generate', {
            method: 'POST',
            body: JSON.stringify({
              destinationId: destId,
              duration: calcDuration,
              travelers: state.project.travelers,
              budget: state.project.budget?.total || 2000000,
              startDate: dates.start
            })
          });

          if (result && result.days) {
            console.log('âœ… AI ì¼ì • ìƒì„± ì„±ê³µ:', result.days.length, 'ì¼');
            dispatch({ type: 'SET_ITINERARY', payload: result });
          } else {
            console.error('âŒ AI ì¼ì • ìƒì„± ì‹¤íŒ¨:', result);
            alert('ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        } catch (err) {
          console.error('âŒ AI ì¼ì • ìƒì„± ì˜¤ë¥˜:', err);
          alert('ì¼ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        setRegenerating(false);
      };

      const typeColors = {
        flight: 'bg-blue-100 text-blue-700 border-blue-200',
        transport: 'bg-indigo-100 text-indigo-700 border-indigo-200',
        hotel: 'bg-purple-100 text-purple-700 border-purple-200',
        food: 'bg-orange-100 text-orange-700 border-orange-200',
        activity: 'bg-green-100 text-green-700 border-green-200',
        shopping: 'bg-pink-100 text-pink-700 border-pink-200'
      };

      return (
        <div>
          {/* Day íƒ­ */}
          <div className="flex overflow-x-auto border-b border-gray-100 px-2 py-2 gap-1 bg-gray-50 scrollbar-none">
            {itinerary.days.map(d => (
              <button key={d.dayNumber} onClick={() => setActiveDay(d.dayNumber)}
                className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  activeDay === d.dayNumber ? 'bg-primary-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}>
                Day{d.dayNumber}
              </button>
            ))}
          </div>

          {/* Day í—¤ë” */}
          <div className="px-4 py-3 bg-white border-b border-gray-100">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-bold text-gray-900">Day {day.dayNumber} <span className="text-sm font-normal text-gray-500">{day.date}</span></h3>
                <p className="text-xs text-gray-500">{day.title}</p>
              </div>
              <div className="text-right">
                <span className="text-xs font-bold text-primary-600 bg-primary-50 px-2 py-1 rounded-lg">
                  ğŸ’° {formatCurrency(getDayCost(day))}
                </span>
                {travelers > 1 && <p className="text-[9px] text-gray-400 mt-0.5">{travelers}ëª… ì´ {formatCurrency(getDayCost(day) * travelers)}</p>}
              </div>
            </div>
          </div>

          {/* íƒ€ì„ìŠ¬ë¡¯ */}
          <div className="px-4 py-3 space-y-1">
            {day.slots.map((slot, i) => {
              const colorClass = typeColors[slot.type] || 'bg-gray-100 text-gray-700 border-gray-200';
              // ì¶œë°œ/ê·€êµ­ ìŠ¬ë¡¯ì— í¸ë„ í•­ê³µë¹„ ìë™ ë¶€ì—¬
              const isDepart = slot.type === 'flight' && (slot.title.includes('ì¶œë°œ') || slot.title.includes('ê·€êµ­'));
              const displayCost = isDepart && slot.cost === 0 && oneWayFlight > 0 ? oneWayFlight : slot.cost;
              // ì¥ì†Œ ë§í¬: ì¡°ì‹/ì ì‹¬/ì €ë…/í˜¸í…”/ê³µí•­/ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ ë“± ì¼ë°˜ ìŠ¬ë¡¯ ì œì™¸, êµ¬ì²´ì  ì¥ì†Œë§Œ ë§í¬
              const genericWords = ['í˜¸í…”', 'ê³µí•­', 'ì¡°ì‹', 'ì ì‹¬', 'ì €ë…', 'ì¶œë°œ', 'ê·€êµ­', 'ë„ì°©', 'ì²´í¬ì¸', 'ì²´í¬ì•„ì›ƒ', 'ì´ë™', 'íœ´ì‹', 'ììœ ì‹œê°„'];
              const isSpecificPlace = slot.title && !genericWords.some(w => slot.title === w || slot.title === `${w} ì‹ì‚¬`)
                && !['meal', 'flight', 'hotel', 'transport'].includes(slot.type);
              const placeQuery = isSpecificPlace ? encodeURIComponent(slot.title.replace(/ë°©ë¬¸|íˆ¬ì–´|ê´€ê´‘|êµ¬ê²½/g, '') + ' ' + destName) : null;
              const hasDetail = !!slot.detail;
              return (
                <div key={i} className="flex gap-3 items-start py-2">
                  <div className="w-12 text-xs font-mono text-gray-500 pt-0.5 flex-shrink-0">{slot.time}</div>
                  <div className="flex-1">
                    <div className={`rounded-lg border p-2.5 ${colorClass} ${hasDetail ? 'cursor-pointer hover:shadow-md transition-shadow ring-0 hover:ring-1 hover:ring-primary-200' : ''}`}
                         onClick={hasDetail ? () => setSelectedSlot(slot) : undefined}>
                      <div className="flex items-start justify-between">
                        <div className="flex items-center gap-1.5">
                          <span className="text-base">{slot.icon}</span>
                          {isSpecificPlace && !hasDetail ? (
                            <a href={`https://www.google.com/search?q=${placeQuery}`} target="_blank" rel="noopener noreferrer"
                              className="font-medium text-sm underline decoration-dotted underline-offset-2 hover:text-blue-600"
                              onClick={(e) => e.stopPropagation()}>
                              {slot.title} <span className="text-[10px] no-underline">ğŸ”—</span>
                            </a>
                          ) : (
                            <span className="font-medium text-sm">{slot.title}</span>
                          )}
                        </div>
                        {displayCost > 0 && (
                          <div className="text-right ml-2 flex-shrink-0">
                            <span className="text-xs font-bold">{formatCurrency(displayCost)}</span>
                            {isDepart && <p className="text-[9px] opacity-60">1ì¸ í¸ë„</p>}
                          </div>
                        )}
                      </div>
                      <div className="flex items-center justify-between mt-1">
                        <div className="flex items-center gap-2">
                          {isSpecificPlace && !hasDetail ? (
                            <a href={`https://www.google.com/maps/search/?api=1&query=${placeQuery}`} target="_blank" rel="noopener noreferrer"
                              className="text-xs opacity-75 hover:opacity-100 hover:text-blue-600"
                              onClick={(e) => e.stopPropagation()}>
                              ğŸ“ {slot.location} <span className="text-[10px]">ì§€ë„</span>
                            </a>
                          ) : (
                            <span className="text-xs opacity-75">ğŸ“ {slot.location}</span>
                          )}
                          {slot.notes && <span className="text-xs opacity-60">Â· {slot.notes}</span>}
                        </div>
                        {hasDetail && (
                          <span className="text-[10px] text-primary-500 font-medium flex-shrink-0">ìƒì„¸ë³´ê¸° â€º</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* AI ì¬ìƒì„± ë²„íŠ¼ */}
          <div className="px-4 py-4">
            <button onClick={regenerateItinerary} disabled={regenerating}
              className="w-full py-2.5 rounded-xl bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 disabled:opacity-50 transition-all">
              {regenerating ? 'â³ ìƒì„± ì¤‘...' : 'ğŸ¤– AIë¡œ ì¼ì • ë‹¤ì‹œ ìƒì„±'}
            </button>
          </div>

          {/* ìŠ¬ë¡¯ ìƒì„¸ ëª¨ë‹¬ */}
          <SlotDetailModal
            slot={selectedSlot}
            destName={destName}
            isOpen={!!selectedSlot}
            onClose={() => setSelectedSlot(null)}
          />
        </div>
      );
    }

    // â”€â”€â”€ í• ì¼ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function TasksTab({ project, dispatch }) {
      const toggleTask = (taskId) => {
        const task = project.tasks.find(t => t.id === taskId);
        if (!task) return;
        const newStatus = task.status === 'completed' ? 'pending' : 'completed';
        dispatch({ type: 'UPDATE_TASK', payload: { id: taskId, status: newStatus } });

        // ë§ˆì¼ìŠ¤í†¤ ì—°ë™
        if (newStatus === 'completed' && task.milestone) {
          const milestoneTasks = project.tasks.filter(t => t.milestone === task.milestone);
          const allDone = milestoneTasks.every(t => t.id === taskId ? true : t.status === 'completed');
          // ë§ˆì¼ìŠ¤í†¤ ì—…ë°ì´íŠ¸ëŠ” í”„ë¡œì íŠ¸ ìˆ˜ì¤€ì—ì„œ ì²˜ë¦¬
        }
      };

      const categoryIcons = {
        transportation: 'âœˆï¸', accommodation: 'ğŸ¨', insurance: 'ğŸ›¡ï¸',
        communication: 'ğŸ“±', finance: 'ğŸ’±', preparation: 'ğŸ§³'
      };

      const priorityColors = {
        high: 'border-l-red-500', medium: 'border-l-yellow-500', low: 'border-l-green-500'
      };

      return (
        <div className="p-4 space-y-3">
          {/* ì§„í–‰ ìš”ì•½ */}
          <div className="bg-primary-50 rounded-xl p-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="text-lg">ğŸ“‹</span>
              <span className="text-sm font-medium text-primary-800">
                {project.tasks.filter(t => t.status === 'completed').length} / {project.tasks.length} ì™„ë£Œ
              </span>
            </div>
            <span className="text-xs text-primary-600 font-bold">
              {Math.round((project.tasks.filter(t => t.status === 'completed').length / project.tasks.length) * 100)}%
            </span>
          </div>

          {/* í• ì¼ ë¦¬ìŠ¤íŠ¸ */}
          {project.tasks.map(task => (
            <div key={task.id}
              className={`bg-white border rounded-xl p-3 border-l-4 ${priorityColors[task.priority] || ''} ${task.status === 'completed' ? 'opacity-60' : ''}`}>
              <div className="flex items-start gap-3">
                <button onClick={() => toggleTask(task.id)}
                  className={`w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 mt-0.5 transition-all ${
                    task.status === 'completed' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-primary-400'
                  }`}>
                  {task.status === 'completed' && <span className="text-xs">âœ“</span>}
                </button>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm">{categoryIcons[task.category] || 'ğŸ“Œ'}</span>
                    <span className={`text-sm font-medium ${task.status === 'completed' ? 'line-through text-gray-400' : 'text-gray-900'}`}>
                      {task.title}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 mt-1">
                    {task.estimatedCost > 0 && (
                      <span className="text-xs text-gray-500">ğŸ’° {formatCurrency(task.estimatedCost)}</span>
                    )}
                    <span className="text-xs text-gray-400">{task.milestone?.toUpperCase()}</span>
                  </div>
                  {/* ì˜ˆì•½ ë§í¬ */}
                  {task.links && task.links.length > 0 && task.status !== 'completed' && (
                    <div className="flex gap-1.5 mt-2 flex-wrap">
                      {task.links.map((link, i) => (
                        <a key={i} href={link.url} target="_blank" rel="noopener noreferrer"
                          className="text-xs bg-primary-50 text-primary-700 px-2 py-0.5 rounded-full hover:bg-primary-100 transition-all">
                          ğŸ”— {link.label}
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    // â”€â”€â”€ ì˜ˆì‚° ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // 1. ì˜ˆì‚° ì•Œë¦¼ ë°°ë„ˆ
    function BudgetAlertsBanner({ project }) {
      const [alerts, setAlerts] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        async function fetchAlerts() {
          setLoading(true);
          const data = await api(`/api/budget/alerts/${project.id}`);
          setAlerts(data);
          setLoading(false);
        }
        fetchAlerts();
      }, [project.id, project.budget]);

      if (loading || !alerts || !alerts.hasAlerts) return null;

      const criticalAlerts = alerts.alerts.filter(a => a.level === 'over' || a.level === 'danger');
      if (criticalAlerts.length === 0) return null;

      const levelColors = {
        over: 'bg-red-100 border-red-300 text-red-800',
        danger: 'bg-orange-100 border-orange-300 text-orange-800',
        warning: 'bg-yellow-100 border-yellow-300 text-yellow-800'
      };

      return (
        <div className="mb-4 space-y-2">
          {criticalAlerts.map((alert, i) => (
            <div key={i} className={`rounded-xl border-2 p-3 ${levelColors[alert.level]}`}>
              <p className="text-sm font-medium">{alert.message}</p>
            </div>
          ))}
        </div>
      );
    }

    // 2. ê±°ë˜ ì¹´ë“œ
    function TransactionCard({ transaction, onDelete }) {
      const categoryIcons = {
        accommodation: 'ğŸ¨', food: 'ğŸœ', activities: 'ğŸ¯',
        transportation: 'ğŸšƒ', shopping: 'ğŸ›ï¸', other: 'ğŸ“¦'
      };

      return (
        <div className="bg-white border border-gray-200 rounded-lg p-3">
          <div className="flex items-start justify-between">
            <div className="flex items-start gap-2 flex-1">
              <span className="text-lg">{categoryIcons[transaction.category] || 'ğŸ’°'}</span>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium text-gray-900 truncate">{transaction.description || 'ê±°ë˜ ë‚´ì—­'}</p>
                <p className="text-xs text-gray-500">{new Date(transaction.date).toLocaleDateString('ko-KR')}</p>
              </div>
            </div>
            <div className="text-right">
              <p className="text-sm font-bold text-gray-900">{formatCurrency(transaction.amount)}</p>
              {transaction.currency !== 'KRW' && (
                <p className="text-xs text-gray-500">{transaction.currency}</p>
              )}
            </div>
          </div>
          {transaction.receipt_url && (
            <p className="text-xs text-primary-600 mt-2">ğŸ“ ì˜ìˆ˜ì¦ ì²¨ë¶€ë¨</p>
          )}
          <button
            onClick={() => onDelete(transaction.id)}
            className="mt-2 text-xs text-red-500 hover:text-red-700"
          >
            ì‚­ì œ
          </button>
        </div>
      );
    }

    // 3. ê±°ë˜ ì¶”ê°€ í¼
    function AddTransactionForm({ project, category, onClose, onSuccess }) {
      const [formData, setFormData] = useState({
        description: '',
        amount: '',
        category: category || 'accommodation',
        date: new Date().toISOString().split('T')[0],
        currency: 'KRW'
      });
      const [submitting, setSubmitting] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitting(true);

        const amountInKRW = parseInt(formData.amount) * 10000;
        const result = await api('/api/transactions', {
          method: 'POST',
          body: JSON.stringify({
            projectId: project.id,
            ...formData,
            amount: amountInKRW
          })
        });

        setSubmitting(false);
        if (result) {
          onSuccess && onSuccess();
          onClose();
        }
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-3">
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">ì„¤ëª…</label>
            <input
              type="text"
              required
              value={formData.description}
              onChange={(e) => setFormData({...formData, description: e.target.value})}
              className="w-full text-sm border border-gray-300 rounded-lg px-3 py-2"
              placeholder="ì˜ˆ: í˜¸í…” ìˆ™ë°•ë¹„"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">ê¸ˆì•¡ (ë§Œì›)</label>
            <input
              type="number"
              required
              value={formData.amount}
              onChange={(e) => setFormData({...formData, amount: e.target.value})}
              className="w-full text-sm border border-gray-300 rounded-lg px-3 py-2"
              placeholder="10 (= 100,000ì›)"
            />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">ì¹´í…Œê³ ë¦¬</label>
            <select
              value={formData.category}
              onChange={(e) => setFormData({...formData, category: e.target.value})}
              className="w-full text-sm border border-gray-300 rounded-lg px-3 py-2"
            >
              <option value="accommodation">ğŸ¨ ìˆ™ì†Œ</option>
              <option value="food">ğŸœ ì‹ë¹„</option>
              <option value="activities">ğŸ¯ í™œë™</option>
              <option value="transportation">ğŸšƒ êµí†µ</option>
              <option value="shopping">ğŸ›ï¸ ì‡¼í•‘</option>
              <option value="other">ğŸ“¦ ê¸°íƒ€</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
            <input
              type="date"
              required
              value={formData.date}
              onChange={(e) => setFormData({...formData, date: e.target.value})}
              className="w-full text-sm border border-gray-300 rounded-lg px-3 py-2"
            />
          </div>
          <div className="flex gap-2">
            <button
              type="submit"
              disabled={submitting}
              className="flex-1 bg-primary-600 text-white rounded-lg py-2 text-sm font-medium disabled:opacity-50"
            >
              {submitting ? 'ì¶”ê°€ ì¤‘...' : 'ê±°ë˜ ì¶”ê°€'}
            </button>
            <button
              type="button"
              onClick={onClose}
              className="px-4 bg-gray-200 text-gray-700 rounded-lg text-sm"
            >
              ì·¨ì†Œ
            </button>
          </div>
        </form>
      );
    }

    // 4. ê±°ë˜ ë‚´ì—­ ì‚¬ì´ë“œ íŒ¨ë„
    function TransactionsSidePanel({ project, category, isOpen, onClose, onTransactionAdded }) {
      const [transactions, setTransactions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showAddForm, setShowAddForm] = useState(false);

      useEffect(() => {
        if (isOpen) {
          fetchTransactions();
        }
      }, [isOpen, category]);

      const fetchTransactions = async () => {
        setLoading(true);
        const endpoint = category
          ? `/api/transactions/project/${project.id}?category=${category}`
          : `/api/transactions/project/${project.id}`;
        const data = await api(endpoint);
        setTransactions(data || []);
        setLoading(false);
      };

      const handleDelete = async (transactionId) => {
        if (!confirm('ì´ ê±°ë˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const result = await api(`/api/transactions/${transactionId}`, { method: 'DELETE' });
        if (result) {
          fetchTransactions();
          onTransactionAdded && onTransactionAdded();
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex justify-end">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="relative w-full max-w-md bg-white h-full overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
              <div className="flex items-center justify-between">
                <h3 className="font-bold text-gray-900">
                  {category ? `${category} ê±°ë˜ ë‚´ì—­` : 'ì „ì²´ ê±°ë˜ ë‚´ì—­'}
                </h3>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
              </div>
              <button
                onClick={() => setShowAddForm(!showAddForm)}
                className="mt-3 w-full bg-primary-600 text-white rounded-lg py-2 text-sm font-medium"
              >
                + ê±°ë˜ ì¶”ê°€
              </button>
            </div>

            <div className="p-4 space-y-3">
              {showAddForm && (
                <div className="bg-gray-50 border border-gray-200 rounded-xl p-4">
                  <AddTransactionForm
                    project={project}
                    category={category}
                    onClose={() => setShowAddForm(false)}
                    onSuccess={() => {
                      fetchTransactions();
                      onTransactionAdded && onTransactionAdded();
                    }}
                  />
                </div>
              )}

              {loading ? (
                <p className="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</p>
              ) : transactions.length === 0 ? (
                <p className="text-center text-gray-500 py-8">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
              ) : (
                transactions.map(tx => (
                  <TransactionCard key={tx.id} transaction={tx} onDelete={handleDelete} />
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    // 5. ì¶”ì²œ ì¹´ë“œ
    function BudgetRecommendationCard({ recommendation, type }) {
      const rec = recommendation;
      // ê°€ê²© í‘œì‹œ (AI ë°ì´í„° ë˜ëŠ” fallback ë°ì´í„° ëª¨ë‘ ì§€ì›)
      const priceText = rec.priceRange || (
        type === 'accommodation' || type === 'ìˆ™ì†Œ' ? (rec.pricePerNight ? `${formatCurrency(rec.pricePerNight)}/ë°•` : '') :
        type === 'food' || type === 'ì‹ë¹„' ? (rec.pricePerPerson ? `${formatCurrency(rec.pricePerPerson)}/ì¸` : '') :
        rec.price ? `${formatCurrency(rec.price)}${rec.duration ? ` Â· ${rec.duration}` : ''}${rec.provider ? ` Â· ${rec.provider}` : ''}` : ''
      );

      return (
        <div className="bg-white border border-gray-200 rounded-xl p-4">
          <div className="flex items-start justify-between mb-2">
            <div>
              <h4 className="font-bold text-gray-900">{rec.name}</h4>
              {rec.type && <span className="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{rec.type}</span>}
            </div>
            {rec.rating && (
              <div className="flex items-center gap-1">
                <span className="text-yellow-500">â­</span>
                <span className="text-sm font-medium">{rec.rating}</span>
              </div>
            )}
          </div>

          {rec.location && <p className="text-xs text-gray-600 mb-2">ğŸ“ {rec.location}</p>}

          {priceText && (
            <p className="text-sm text-primary-700 font-medium mb-2">{priceText}</p>
          )}

          {(rec.reason || rec.tip) && (
            <p className="text-xs text-gray-700 mb-3">ğŸ’¡ {rec.reason || rec.tip}</p>
          )}

          {rec.bookingUrl && (
            <a href={rec.bookingUrl} target="_blank" rel="noopener noreferrer"
              className="text-xs text-blue-600 hover:underline">ì˜ˆì•½ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸° â†’</a>
          )}

          {rec.reviews && rec.reviews.length > 0 && (
            <div className="space-y-2 mb-3">
              <p className="text-xs font-medium text-gray-500">ìµœê·¼ ë¦¬ë·°</p>
              {rec.reviews.slice(0, 2).map((review, i) => (
                <div key={i} className="bg-gray-50 rounded-lg p-2">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs font-medium text-gray-700">{review.user}</span>
                    <span className="text-xs text-yellow-500">{'â­'.repeat(review.rating)}</span>
                  </div>
                  <p className="text-xs text-gray-600">{review.comment}</p>
                </div>
              ))}
            </div>
          )}

          {recommendation.features && (
            <div className="flex flex-wrap gap-1">
              {recommendation.features.slice(0, 3).map((feature, i) => (
                <span key={i} className="text-xs bg-primary-50 text-primary-700 px-2 py-1 rounded-full">
                  {feature}
                </span>
              ))}
            </div>
          )}
        </div>
      );
    }

    // 6. ì¶”ì²œ ëª¨ë‹¬
    function RecommendationsModal({ project, category, isOpen, onClose }) {
      const [recommendations, setRecommendations] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        if (isOpen && category) {
          fetchRecommendations();
        }
      }, [isOpen, category]);

      const fetchRecommendations = async () => {
        setLoading(true);
        const data = await api(`/api/recommend/${category}`, {
          method: 'POST',
          body: JSON.stringify({ projectId: project.id })
        });
        setRecommendations(data);
        setLoading(false);
      };

      if (!isOpen) return null;

      const categoryNames = {
        accommodation: 'ìˆ™ì†Œ', food: 'ì‹ë¹„',
        activities: 'í™œë™', transportation: 'êµí†µ'
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={onClose}></div>
          <div className="relative w-full max-w-2xl bg-white rounded-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-4 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="font-bold text-lg text-gray-900">
                  {categoryNames[category]} ì¶”ì²œ
                </h3>
                <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-xl">âœ•</button>
              </div>
              {recommendations?.fromCache && (
                <p className="text-xs text-gray-500 mt-1">ğŸ’¾ ìºì‹œëœ ì¶”ì²œ (24ì‹œê°„ ìœ íš¨)</p>
              )}
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {loading ? (
                <div className="text-center py-12">
                  <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                  <p className="text-sm text-gray-500 mt-3">AI ì¶”ì²œ ìƒì„± ì¤‘...</p>
                </div>
              ) : !recommendations || !recommendations.recommendations ? (
                <p className="text-center text-gray-500 py-8">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
              ) : (
                recommendations.recommendations.map((rec, i) => (
                  <BudgetRecommendationCard key={i} recommendation={rec} type={category} />
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    // 7. ì˜ˆì‚° ì¹´í…Œê³ ë¦¬ ì¹´ë“œ (í´ë¦­ ê°€ëŠ¥)
    function BudgetCategoryCard({ category, data, icon, color, onShowRecommendations, onShowTransactions }) {
      const allocated = data.allocated || data.budget || 0;
      const spent = data.spent || 0;
      const pct = allocated > 0 ? Math.round((spent / allocated) * 100) : 0;
      const categoryMap = {
        'ìˆ™ì†Œ': 'accommodation',
        'ì‹ë¹„': 'food',
        'í™œë™': 'activities',
        'êµí†µ': 'transportation'
      };
      const categoryKey = categoryMap[category];

      return (
        <div
          className="bg-white border-2 border-gray-200 rounded-xl p-4 hover:border-primary-300 hover:shadow-md transition-all cursor-pointer"
          onClick={() => onShowRecommendations(categoryKey)}
        >
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <span className="text-2xl">{icon}</span>
              <span className="text-sm font-bold text-gray-900">{category}</span>
            </div>
            <button
              onClick={(e) => {
                e.stopPropagation();
                onShowTransactions(categoryKey);
              }}
              className="text-xs text-primary-600 hover:text-primary-800"
            >
              ë‚´ì—­ â†’
            </button>
          </div>

          <div className="bg-gray-100 rounded-full h-3 mb-2">
            <div
              className={`rounded-full h-3 transition-all duration-500 ${color}`}
              style={{width: `${Math.min(pct, 100)}%`}}
            ></div>
          </div>

          <div className="flex justify-between text-xs">
            <span className="text-gray-600">
              {formatCurrency(spent)} / {formatCurrency(allocated)}
            </span>
            <span className={pct > 100 ? 'text-red-600 font-bold' : pct > 80 ? 'text-orange-600 font-bold' : 'text-gray-500'}>
              {pct}%
            </span>
          </div>

          {pct > 100 && (
            <p className="text-xs text-red-500 mt-2 font-medium">âš ï¸ ì˜ˆì‚° {pct - 100}% ì´ˆê³¼!</p>
          )}

          <p className="text-xs text-primary-600 mt-2 font-medium">
            ğŸ’¡ í´ë¦­í•˜ì—¬ AI ì¶”ì²œ ë³´ê¸°
          </p>
        </div>
      );
    }

    // â”€â”€â”€ ì˜ˆì‚° íƒ­ (ê°œì„ ëœ ë²„ì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function BudgetTab({ project, totalSpent, dispatch }) {
      const budget = project.budget;
      const remaining = budget.total - totalSpent;
      const usagePercent = Math.round((totalSpent / budget.total) * 100);

      const [selectedCategory, setSelectedCategory] = useState(null);
      const [showRecommendations, setShowRecommendations] = useState(false);
      const [showTransactions, setShowTransactions] = useState(false);
      const [refreshKey, setRefreshKey] = useState(0);

      const catIcons = { ìˆ™ì†Œ: 'ğŸ¨', ì‹ë¹„: 'ğŸœ', í™œë™: 'ğŸ¯', êµí†µ: 'ğŸšƒ', ê¸°íƒ€: 'ğŸ“¦' };
      const catColors = {
        ìˆ™ì†Œ: 'bg-purple-500', ì‹ë¹„: 'bg-orange-500',
        í™œë™: 'bg-green-500', êµí†µ: 'bg-indigo-500', ê¸°íƒ€: 'bg-gray-500'
      };

      const handleTransactionAdded = async () => {
        // Refresh project data from backend
        const updated = await api(`/api/projects/${project.id}`);
        if (updated) {
          dispatch({ type: 'SET_PROJECT', payload: updated });
          setRefreshKey(prev => prev + 1);
        }
      };

      const mainCategories = ['ìˆ™ì†Œ', 'ì‹ë¹„', 'í™œë™', 'êµí†µ'];

      return (
        <div className="p-4 space-y-4">
          {/* ì˜ˆì‚° ì•Œë¦¼ ë°°ë„ˆ */}
          <BudgetAlertsBanner project={project} key={refreshKey} />

          {/* ì „ì²´ ì˜ˆì‚° ì¹´ë“œ */}
          <div className="bg-gradient-to-br from-primary-500 to-purple-600 text-white rounded-2xl p-4">
            <div className="flex items-center justify-between mb-1">
              <p className="text-xs text-purple-200">ì´ ì˜ˆì‚°</p>
              <span className="text-xs bg-white/20 px-2 py-1 rounded-full">ì´ {project.travelers}ëª…</span>
            </div>
            <p className="text-3xl font-bold">{formatCurrency(budget.total)}</p>
            <div className="mt-3 flex items-center gap-3">
              <div className="flex-1 bg-white/20 rounded-full h-3">
                <div className={`rounded-full h-3 transition-all duration-500 ${usagePercent > 90 ? 'bg-red-400' : usagePercent > 70 ? 'bg-yellow-400' : 'bg-white'}`}
                  style={{width: `${Math.min(usagePercent, 100)}%`}}></div>
              </div>
              <span className="text-sm font-bold">{usagePercent}%</span>
            </div>
            <div className="flex justify-between mt-2 text-xs text-purple-200">
              <span>ì‚¬ìš©: {formatCurrency(totalSpent)}</span>
              <span>ì”ì—¬: {formatCurrency(remaining)}</span>
            </div>
          </div>

          {/* ì¹´í…Œê³ ë¦¬ë³„ ì¹´ë“œ (í´ë¦­ ê°€ëŠ¥) */}
          <div className="grid grid-cols-2 gap-3">
            {mainCategories.map(cat => {
              const data = budget.categories[cat] || { budget: 0, allocated: 0, spent: 0 };
              return (
                <BudgetCategoryCard
                  key={cat}
                  category={cat}
                  data={data}
                  icon={catIcons[cat]}
                  color={catColors[cat]}
                  onShowRecommendations={(categoryKey) => {
                    setSelectedCategory(categoryKey);
                    setShowRecommendations(true);
                  }}
                  onShowTransactions={(categoryKey) => {
                    setSelectedCategory(categoryKey);
                    setShowTransactions(true);
                  }}
                />
              );
            })}
          </div>

          {/* ì˜ˆì‚° íŒ */}
          <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-3">
            <h4 className="text-xs font-bold text-yellow-800 mb-1">ğŸ’¡ ì˜ˆì‚° ì ˆì•½ íŒ</h4>
            <ul className="text-xs text-yellow-700 space-y-1">
              <li>â€¢ LCC í•­ê³µì‚¬ ì´ìš© ì‹œ ìµœëŒ€ 40% ì ˆì•½</li>
              <li>â€¢ í˜¸í…” ëŒ€ì‹  ì—ì–´ë¹„ì•¤ë¹„ë¡œ 20-30% ì ˆì•½</li>
              <li>â€¢ í˜„ì§€ ë§ˆíŠ¸/í¸ì˜ì  í™œìš©ìœ¼ë¡œ ì‹ë¹„ ì ˆì•½</li>
              <li>â€¢ êµí†µíŒ¨ìŠ¤(JRíŒ¨ìŠ¤ ë“±) êµ¬ë§¤ë¡œ êµí†µë¹„ ì ˆì•½</li>
            </ul>
          </div>

          {/* ì¶”ì²œ ëª¨ë‹¬ */}
          <RecommendationsModal
            project={project}
            category={selectedCategory}
            isOpen={showRecommendations}
            onClose={() => setShowRecommendations(false)}
          />

          {/* ê±°ë˜ ë‚´ì—­ ì‚¬ì´ë“œ íŒ¨ë„ */}
          <TransactionsSidePanel
            project={project}
            category={selectedCategory}
            isOpen={showTransactions}
            onClose={() => setShowTransactions(false)}
            onTransactionAdded={handleTransactionAdded}
          />
        </div>
      );
    }

    // â”€â”€â”€ ì§€ë„ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function MapTab({ itinerary, project }) {
      const [activeDay, setActiveDay] = useState(1);

      // ëª©ì ì§€ë³„ ì¢Œí‘œ
      const destCoords = {
        osaka: { lat: 34.6937, lng: 135.5023, zoom: 13 },
        tokyo: { lat: 35.6762, lng: 139.6503, zoom: 12 },
        danang: { lat: 16.0544, lng: 108.2022, zoom: 13 },
        bali: { lat: -8.3405, lng: 115.0920, zoom: 11 },
        bangkok: { lat: 13.7563, lng: 100.5018, zoom: 13 },
        paris: { lat: 48.8566, lng: 2.3522, zoom: 13 },
        jeju: { lat: 33.4996, lng: 126.5312, zoom: 11 },
        okinawa: { lat: 26.3344, lng: 127.8056, zoom: 11 },
        singapore: { lat: 1.3521, lng: 103.8198, zoom: 12 },
        hawaii: { lat: 21.3069, lng: -157.8583, zoom: 12 }
      };

      // ì¥ì†Œë³„ ê²€ìƒ‰ ì¢Œí‘œ (Google Mapsì—ì„œ ì¥ì†Œ ê²€ìƒ‰ìš©)
      const locationCoords = {
        'ë„í†¤ë³´ë¦¬': { lat: 34.6687, lng: 135.5013 },
        'ì‹ ì‚¬ì´ë°”ì‹œ': { lat: 34.6726, lng: 135.5007 },
        'USJ': { lat: 34.6654, lng: 135.4323 },
        'ì˜¤ì‚¬ì¹´ì„±': { lat: 34.6873, lng: 135.5262 },
        'êµ¬ë¡œëª¬ì‹œì¥': { lat: 34.6628, lng: 135.5069 },
        'ì‹œë¶€ì•¼': { lat: 35.6580, lng: 139.7016 },
        'í•˜ë¼ì£¼ì¿ ': { lat: 35.6702, lng: 139.7026 },
        'ì•„ì‚¬ì¿ ì‚¬': { lat: 35.7148, lng: 139.7967 },
        'ë¯¸ì¼€ë¹„ì¹˜': { lat: 16.0367, lng: 108.2462 },
        'ë°”ë‚˜í': { lat: 15.9977, lng: 107.9875 },
        'í˜¸ì´ì•ˆ': { lat: 15.8801, lng: 108.3380 },
        'ìš°ë¶“': { lat: -8.5069, lng: 115.2625 },
        'ìŠ¤ë¯¸ëƒ‘': { lat: -8.6913, lng: 115.1683 },
        'ì¿ íƒ€ë¹„ì¹˜': { lat: -8.7184, lng: 115.1686 },
        'í˜‘ì¬í•´ìˆ˜ìš•ì¥': { lat: 33.3939, lng: 126.2397 },
        'ì„±ì‚°ì¼ì¶œë´‰': { lat: 33.4582, lng: 126.9425 },
      };

      const coords = destCoords[project?.destination?.id] || { lat: 35.6762, lng: 139.6503, zoom: 5 };

      if (!itinerary) {
        return (
          <div className="p-8 text-center text-gray-500">
            <p className="text-4xl mb-2">ğŸ—ºï¸</p>
            <p className="text-sm">ì¼ì •ì„ ë¨¼ì € ìƒì„±í•˜ë©´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
        );
      }

      const day = itinerary.days.find(d => d.dayNumber === activeDay) || itinerary.days[0];
      const places = day.slots.filter(s => s.location && s.type !== 'flight');

      // Google Maps Embed URL (API í‚¤ ë¶ˆí•„ìš”)
      const mapQuery = encodeURIComponent(`${project.destination.name} ${day.slots[0]?.location || ''}`);
      const mapUrl = `https://www.google.com/maps/embed/v1/search?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(project.destination.name + ' ê´€ê´‘')}&center=${coords.lat},${coords.lng}&zoom=${coords.zoom || 13}&language=ko`;

      return (
        <div className="flex flex-col h-full">
          {/* Day ì„ íƒ */}
          <div className="flex overflow-x-auto border-b border-gray-100 px-2 py-2 gap-1 bg-gray-50 scrollbar-none">
            {itinerary.days.map(d => (
              <button key={d.dayNumber} onClick={() => setActiveDay(d.dayNumber)}
                className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  activeDay === d.dayNumber ? 'bg-primary-600 text-white shadow-sm' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}>
                Day{d.dayNumber}
              </button>
            ))}
          </div>

          {/* ì§€ë„ */}
          <div className="relative" style={{height: '250px'}}>
            <iframe
              width="100%" height="250" style={{border:0}}
              loading="lazy" referrerPolicy="no-referrer-when-downgrade"
              src={`https://maps.google.com/maps?q=${encodeURIComponent(project.destination.name)}&t=&z=${coords.zoom || 13}&ie=UTF8&iwloc=&output=embed`}
            ></iframe>
          </div>

          {/* ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ */}
          <div className="flex-1 overflow-y-auto px-4 py-3">
            <h4 className="text-xs font-bold text-gray-500 mb-2">ğŸ“ Day {day.dayNumber} ë°©ë¬¸ ì¥ì†Œ</h4>
            <div className="space-y-2">
              {places.map((slot, i) => (
                <a key={i}
                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(slot.location + ' ' + (slot.title || '') + ' ' + project.destination.country)}`}
                  target="_blank" rel="noopener noreferrer"
                  className="flex items-center gap-3 p-2.5 bg-white border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-sm transition-all">
                  <span className="text-lg">{slot.icon}</span>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-gray-900 truncate">{slot.title}</p>
                    <p className="text-xs text-gray-500">ğŸ“ {slot.location} Â· {slot.time}</p>
                  </div>
                  <span className="text-xs text-primary-600 flex-shrink-0">ì§€ë„ â†’</span>
                </a>
              ))}
            </div>

            {/* ì „ì²´ ê²½ë¡œ ë³´ê¸° */}
            {places.length >= 2 && (
              <a href={`https://www.google.com/maps/dir/${places.map(p => encodeURIComponent(p.location + ' ' + project.destination.name)).join('/')}`}
                target="_blank" rel="noopener noreferrer"
                className="mt-3 flex items-center justify-center gap-2 w-full py-2.5 bg-blue-50 text-blue-700 rounded-xl text-sm font-medium hover:bg-blue-100 transition-all">
                ğŸš— Day {day.dayNumber} ì „ì²´ ê²½ë¡œ ë³´ê¸° (Google Maps)
              </a>
            )}
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ë¹„ìš© ì‹œë®¬ë ˆì´ì…˜ + êµ¬ë§¤ ì—°ê³„ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function SimulatorTab({ project, state, dispatch }) {
      const dest = project.destination;
      const userSettings = state?.userSettings || { homeCity: 'ì„œìš¸', defaultTravelers: 2, fuelEfficiency: 10, fuelPrice: 1700 };
      const [simTravelers, setSimTravelers] = useState(project.travelers || userSettings.defaultTravelers || 2);
      const [simDays, setSimDays] = useState(dest?.sampleItinerary?.days || 5);
      const [simType, setSimType] = useState(project.travelType || 'free');
      const [simClass, setSimClass] = useState('economy'); // economy, business
      const [simHotel, setSimHotel] = useState('mid'); // budget, mid, luxury
      const [alerts, setAlerts] = useState([]);
      const [alertEnabled, setAlertEnabled] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [fuelEfficiency, setFuelEfficiency] = useState(userSettings.fuelEfficiency || 10);
      const [fuelPrice, setFuelPrice] = useState(userSettings.fuelPrice || 1700);

      // êµ­ë‚´ ëª©ì ì§€ íŒë³„ ë° ê±°ë¦¬ ê³„ì‚°
      const domesticDestinations = {
        'ë¶€ì‚°': { distance: 400, tollFee: 28000 },
        'ê²½ì£¼': { distance: 370, tollFee: 25000 },
        'ì „ì£¼': { distance: 230, tollFee: 15000 },
        'ê°•ë¦‰': { distance: 210, tollFee: 12000 },
        'ì†ì´ˆ': { distance: 180, tollFee: 10000 },
        'ì—¬ìˆ˜': { distance: 380, tollFee: 26000 },
        'ê´‘ì£¼': { distance: 290, tollFee: 18000 },
        'ëŒ€ì „': { distance: 150, tollFee: 10000 },
        'ëŒ€êµ¬': { distance: 300, tollFee: 20000 },
        'ìš¸ì‚°': { distance: 380, tollFee: 26000 },
        'ì œì£¼ë„': { distance: 0, tollFee: 0, needsFlight: true },
        'ì œì£¼': { distance: 0, tollFee: 0, needsFlight: true },
        'ì¶˜ì²œ': { distance: 85, tollFee: 5000 },
        'ì•ˆë™': { distance: 260, tollFee: 17000 },
        'í†µì˜': { distance: 350, tollFee: 24000 },
        'ê±°ì œ': { distance: 380, tollFee: 26000 },
        'ëª©í¬': { distance: 350, tollFee: 24000 },
        'ìˆœì²œ': { distance: 340, tollFee: 23000 }
      };

      const destName = dest?.name || '';
      const country = dest?.country || '';
      const isDomestic = country === 'ëŒ€í•œë¯¼êµ­' || country === 'í•œêµ­' || country === 'Korea' || country === 'South Korea' || Object.keys(domesticDestinations).includes(destName);
      const domesticInfo = domesticDestinations[destName];
      const isJeju = destName.includes('ì œì£¼');
      const needsCar = isDomestic && !isJeju;

      // ë¹„ìš© ê³„ì‚° ì—”ì§„ - ë‹¨ìœ„ ì˜¤ë¥˜ ë°©ì§€ ê²€ì¦ í¬í•¨
      let baseCost = dest?.avgCost || 1000000;
      // 100,000ì› ë¯¸ë§Œì´ë©´ ë‹¨ìœ„ ì˜¤ë¥˜ë¡œ íŒë‹¨í•˜ì—¬ x100 ì²˜ë¦¬
      if (baseCost < 100000) {
        console.warn(`âš ï¸ baseCost ë‹¨ìœ„ ì˜¤ë¥˜ ê°ì§€: ${baseCost}ì› â†’ ${baseCost * 100}ì›`);
        baseCost = baseCost * 100;
      }
      // ìµœì†Œ 200,000ì› ë³´ì¥ (êµ­ë‚´ì—¬í–‰ì€ ë” ë‚®ì€ ê¸°ì¤€)
      if (baseCost < 200000 && !isDomestic) baseCost = 500000;
      if (baseCost < 100000 && isDomestic) baseCost = 150000;

      const flightMultiplier = simClass === 'business' ? 2.5 : 1;
      const hotelMultiplier = simHotel === 'luxury' ? 2.2 : simHotel === 'budget' ? 0.6 : 1;
      const typeDiscount = simType === 'package' ? 0.8 : 1;

      // ìë™ì°¨ ë¹„ìš© ê³„ì‚° (êµ­ë‚´ì—¬í–‰ìš©)
      const distance = domesticInfo?.distance || 300; // ê¸°ë³¸ 300km
      const tollFee = domesticInfo?.tollFee || 20000; // ê¸°ë³¸ í†¨ë¹„
      const fuelCost = Math.round((distance * 2) / fuelEfficiency * fuelPrice); // ì™•ë³µ ìœ ë¥˜ë¹„
      const totalToll = tollFee * 2; // ì™•ë³µ í†¨ë¹„

      // ë„ì‹œëª… ë³„ì¹­ â†’ í‘œì¤€ëª… ë§¤í•‘ (AIê°€ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆìŒ)
      const cityAliases = {
        'í˜¸ë†€ë£°ë£¨': 'í•˜ì™€ì´', 'ì™€ì´í‚¤í‚¤': 'í•˜ì™€ì´', 'Honolulu': 'í•˜ì™€ì´', 'Hawaii': 'í•˜ì™€ì´',
        'ë„ì¿„': 'ë„ì¿„', 'ë™ê²½': 'ë„ì¿„', 'Tokyo': 'ë„ì¿„',
        'ì˜¤ì‚¬ì¹´': 'ì˜¤ì‚¬ì¹´', 'Osaka': 'ì˜¤ì‚¬ì¹´',
        'ë°©ì½•': 'ë°©ì½•', 'Bangkok': 'ë°©ì½•',
        'ì‹±ê°€í¬ë¥´': 'ì‹±ê°€í¬ë¥´', 'Singapore': 'ì‹±ê°€í¬ë¥´',
        'ë°œë¦¬': 'ë°œë¦¬', 'ë´íŒŒì‚¬ë¥´': 'ë°œë¦¬', 'Bali': 'ë°œë¦¬',
        'ì„¸ë¶€': 'ì„¸ë¶€', 'Cebu': 'ì„¸ë¶€',
        'íƒ€ì´ë² ì´': 'íƒ€ì´ë² ì´', 'íƒ€ì´í˜ì´': 'íƒ€ì´ë² ì´', 'ëŒ€ë§Œ': 'íƒ€ì´ë² ì´', 'Taipei': 'íƒ€ì´ë² ì´',
        'í™ì½©': 'í™ì½©', 'Hong Kong': 'í™ì½©',
        'ë‹¤ë‚­': 'ë‹¤ë‚­', 'Da Nang': 'ë‹¤ë‚­',
        'í˜¸ì¹˜ë¯¼': 'í˜¸ì¹˜ë¯¼', 'ì‚¬ì´ê³µ': 'í˜¸ì¹˜ë¯¼', 'Ho Chi Minh': 'í˜¸ì¹˜ë¯¼',
        'ë‚˜íŠ¸ë‘': 'ë‚˜íŠ¸ë‘', 'Nha Trang': 'ë‚˜íŠ¸ë‘',
        'íŒŒë¦¬': 'íŒŒë¦¬', 'Paris': 'íŒŒë¦¬',
        'ëŸ°ë˜': 'ëŸ°ë˜', 'London': 'ëŸ°ë˜',
        'ë¡œë§ˆ': 'ë¡œë§ˆ', 'Rome': 'ë¡œë§ˆ',
        'ë°”ë¥´ì…€ë¡œë‚˜': 'ë°”ë¥´ì…€ë¡œë‚˜', 'Barcelona': 'ë°”ë¥´ì…€ë¡œë‚˜',
        'ì´ìŠ¤íƒ„ë¶ˆ': 'ì´ìŠ¤íƒ„ë¶ˆ', 'Istanbul': 'ì´ìŠ¤íƒ„ë¶ˆ',
        'ë‰´ìš•': 'ë‰´ìš•', 'New York': 'ë‰´ìš•',
        'ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤': 'LA', 'ì—˜ì—ì´': 'LA', 'Los Angeles': 'LA',
        'ì‹œë“œë‹ˆ': 'ì‹œë“œë‹ˆ', 'Sydney': 'ì‹œë“œë‹ˆ',
        'ê´Œ': 'ê´Œ', 'Guam': 'ê´Œ',
        'ì‚¬ì´íŒ': 'ì‚¬ì´íŒ', 'Saipan': 'ì‚¬ì´íŒ',
        'í›„ì¿ ì˜¤ì¹´': 'í›„ì¿ ì˜¤ì¹´', 'Fukuoka': 'í›„ì¿ ì˜¤ì¹´',
        'ì‚¿í¬ë¡œ': 'ì‚¿í¬ë¡œ', 'Sapporo': 'ì‚¿í¬ë¡œ',
        'ì˜¤í‚¤ë‚˜ì™€': 'ì˜¤í‚¤ë‚˜ì™€', 'Okinawa': 'ì˜¤í‚¤ë‚˜ì™€',
        'í”„ë¼í•˜': 'í”„ë¼í•˜', 'Prague': 'í”„ë¼í•˜',
        'ë¹ˆ': 'ë¹ˆ', 'ë¹„ì—”ë‚˜': 'ë¹ˆ', 'Vienna': 'ë¹ˆ',
        'ì·¨ë¦¬íˆ': 'ì·¨ë¦¬íˆ', 'Zurich': 'ì·¨ë¦¬íˆ',
        'ì•”ìŠ¤í…Œë¥´ë‹´': 'ì•”ìŠ¤í…Œë¥´ë‹´', 'Amsterdam': 'ì•”ìŠ¤í…Œë¥´ë‹´',
        'ë®Œí—¨': 'ë®Œí—¨', 'Munich': 'ë®Œí—¨',
        'ë°©ì½•': 'ë°©ì½•', 'í¬ë¼ë¹„': 'í¬ë¼ë¹„', 'í‘¸ì¼“': 'í‘¸ì¼“',
        'ì¹¸ì¿¤': 'ì¹¸ì¿¤', 'Cancun': 'ì¹¸ì¿¤',
        'ëª°ë””ë¸Œ': 'ëª°ë””ë¸Œ', 'Maldives': 'ëª°ë””ë¸Œ',
        'í€¸ìŠ¤íƒ€ìš´': 'í€¸ìŠ¤íƒ€ìš´', 'Queenstown': 'í€¸ìŠ¤íƒ€ìš´',
        'ì˜¤í´ëœë“œ': 'ì˜¤í´ëœë“œ', 'Auckland': 'ì˜¤í´ëœë“œ',
        'í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜': 'í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜', 'Christchurch': 'í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜',
        'ë©œë²„ë¥¸': 'ë©œë²„ë¥¸', 'Melbourne': 'ë©œë²„ë¥¸',
        'í”¼ì§€': 'í”¼ì§€', 'Fiji': 'í”¼ì§€',
        'ë‘ë¸Œë¡œë¸Œë‹ˆí¬': 'ë‘ë¸Œë¡œë¸Œë‹ˆí¬', 'Dubrovnik': 'ë‘ë¸Œë¡œë¸Œë‹ˆí¬',
        'ì‚°í† ë¦¬ë‹ˆ': 'ì‚°í† ë¦¬ë‹ˆ', 'Santorini': 'ì‚°í† ë¦¬ë‹ˆ',
        'ë ˆì´ìº¬ë¹„í¬': 'ë ˆì´ìº¬ë¹„í¬', 'Reykjavik': 'ë ˆì´ìº¬ë¹„í¬',
        'ë¦¬ìŠ¤ë³¸': 'ë¦¬ìŠ¤ë³¸', 'Lisbon': 'ë¦¬ìŠ¤ë³¸',
        'ë¶€ë‹¤í˜ìŠ¤íŠ¸': 'ë¶€ë‹¤í˜ìŠ¤íŠ¸', 'Budapest': 'ë¶€ë‹¤í˜ìŠ¤íŠ¸',
        'ë² ë¥¼ë¦°': 'ë² ë¥¼ë¦°', 'Berlin': 'ë² ë¥¼ë¦°',
        'ë°€ë¼ë…¸': 'ë°€ë¼ë…¸', 'Milan': 'ë°€ë¼ë…¸',
        'ë² ë„¤ì¹˜ì•„': 'ë² ë„¤ì¹˜ì•„', 'ë² ë‹ˆìŠ¤': 'ë² ë„¤ì¹˜ì•„', 'Venice': 'ë² ë„¤ì¹˜ì•„',
        'ë‹ˆìŠ¤': 'ë‹ˆìŠ¤', 'Nice': 'ë‹ˆìŠ¤',
        'ë§ˆë“œë¦¬ë“œ': 'ë§ˆë“œë¦¬ë“œ', 'Madrid': 'ë§ˆë“œë¦¬ë“œ',
        'ë”ë¸”ë¦°': 'ë”ë¸”ë¦°', 'Dublin': 'ë”ë¸”ë¦°',
        'í—¬ì‹±í‚¤': 'í—¬ì‹±í‚¤', 'Helsinki': 'í—¬ì‹±í‚¤',
        'ì¹˜ì•™ë§ˆì´': 'ì¹˜ì•™ë§ˆì´', 'Chiang Mai': 'ì¹˜ì•™ë§ˆì´',
        'ì½”ì‚¬ë¬´ì´': 'ì½”ì‚¬ë¬´ì´', 'Koh Samui': 'ì½”ì‚¬ë¬´ì´',
        'í•˜ë…¸ì´': 'í•˜ë…¸ì´', 'Hanoi': 'í•˜ë…¸ì´',
        'í‘¸ê¾¸ì˜¥': 'í‘¸ê¾¸ì˜¥', 'Phu Quoc': 'í‘¸ê¾¸ì˜¥',
        'ë³´ë¼ì¹´ì´': 'ë³´ë¼ì¹´ì´', 'Boracay': 'ë³´ë¼ì¹´ì´',
        'ë‘ì¹´ìœ„': 'ë‘ì¹´ìœ„', 'Langkawi': 'ë‘ì¹´ìœ„',
        'ì½”íƒ€í‚¤ë‚˜ë°œë£¨': 'ì½”íƒ€í‚¤ë‚˜ë°œë£¨', 'Kota Kinabalu': 'ì½”íƒ€í‚¤ë‚˜ë°œë£¨',
        'ë¼ìŠ¤ë² ê°€ìŠ¤': 'ë¼ìŠ¤ë² ê°€ìŠ¤', 'Las Vegas': 'ë¼ìŠ¤ë² ê°€ìŠ¤',
        'ìƒŒí”„ë€ì‹œìŠ¤ì½”': 'ìƒŒí”„ë€ì‹œìŠ¤ì½”', 'San Francisco': 'ìƒŒí”„ë€ì‹œìŠ¤ì½”',
        'ì‹œì¹´ê³ ': 'ì‹œì¹´ê³ ', 'Chicago': 'ì‹œì¹´ê³ ',
        'ë°´ì¿ ë²„': 'ë°´ì¿ ë²„', 'Vancouver': 'ë°´ì¿ ë²„',
        'í† ë¡ í† ': 'í† ë¡ í† ', 'Toronto': 'í† ë¡ í† ',
        'ì¹´ì´ë¡œ': 'ì¹´ì´ë¡œ', 'Cairo': 'ì¹´ì´ë¡œ',
        'ì¼€ì´í”„íƒ€ìš´': 'ì¼€ì´í”„íƒ€ìš´', 'Cape Town': 'ì¼€ì´í”„íƒ€ìš´'
      };
      const matchedName = cityAliases[destName] || destName;

      // í•­ê³µë£Œ: 1ì¸ ì™•ë³µ(Round-trip) ê¸°ì¤€, ì„±ìˆ˜ê¸°(7~8ì›”) í‰ê·  ì‹œì„¸ (2025~2026 ìŠ¤ì¹´ì´ìŠ¤ìºë„ˆ/ë„¤ì´ë²„í•­ê³µê¶Œ ì°¸ê³ )
      const flightPriceMap = {
        // ì¼ë³¸ (ì§í•­ 2~3.5ì‹œê°„)
        'ë„ì¿„': 600000, 'ì˜¤ì‚¬ì¹´': 550000, 'í›„ì¿ ì˜¤ì¹´': 450000, 'ì‚¿í¬ë¡œ': 650000, 'ì˜¤í‚¤ë‚˜ì™€': 600000,
        // ë™ë‚¨ì•„ (ì§í•­ 4~7ì‹œê°„)
        'ë°©ì½•': 700000, 'ë‹¤ë‚­': 600000, 'í˜¸ì¹˜ë¯¼': 650000, 'ë‚˜íŠ¸ë‘': 650000,
        'ì‹±ê°€í¬ë¥´': 800000, 'ë°œë¦¬': 900000, 'ì„¸ë¶€': 550000,
        'í¬ë¼ë¹„': 800000, 'í‘¸ì¼“': 800000,
        // ì¤‘í™”ê¶Œ (ì§í•­ 2~4ì‹œê°„)
        'íƒ€ì´ë² ì´': 500000, 'í™ì½©': 550000,
        // ë¯¸ì£¼/íƒœí‰ì–‘ (9~17ì‹œê°„)
        'ê´Œ': 800000, 'ì‚¬ì´íŒ': 850000, 'í•˜ì™€ì´': 1800000,
        'ë‰´ìš•': 2200000, 'LA': 1800000, 'ì¹¸ì¿¤': 2500000,
        // ìœ ëŸ½ (11~13ì‹œê°„)
        'íŒŒë¦¬': 1800000, 'ëŸ°ë˜': 1800000, 'ë¡œë§ˆ': 1700000, 'ë°”ë¥´ì…€ë¡œë‚˜': 1700000,
        'ì´ìŠ¤íƒ„ë¶ˆ': 1400000,
        'í”„ë¼í•˜': 1600000, 'ë¹ˆ': 1700000, 'ì·¨ë¦¬íˆ': 1900000, 'ì•”ìŠ¤í…Œë¥´ë‹´': 1700000, 'ë®Œí—¨': 1700000,
        // ì˜¤ì„¸ì•„ë‹ˆì•„/ê¸°íƒ€
        'ì‹œë“œë‹ˆ': 1500000, 'ëª°ë””ë¸Œ': 2000000,
        // êµ­ë‚´
        'ì œì£¼ë„': 200000, 'ë¶€ì‚°': 0
      };
      // í¸ë„ ë¹„í–‰ì‹œê°„ (ì‹œê°„ ë‹¨ìœ„, ì§í•­ ê¸°ì¤€)
      const flightHoursMap = {
        'ë„ì¿„': 2.5, 'ì˜¤ì‚¬ì¹´': 2, 'í›„ì¿ ì˜¤ì¹´': 1.5, 'ì‚¿í¬ë¡œ': 3.5, 'ì˜¤í‚¤ë‚˜ì™€': 2.5,
        'ë°©ì½•': 5.5, 'ë‹¤ë‚­': 4.5, 'í˜¸ì¹˜ë¯¼': 5.5, 'ë‚˜íŠ¸ë‘': 5,
        'ì‹±ê°€í¬ë¥´': 6.5, 'ë°œë¦¬': 7, 'ì„¸ë¶€': 4.5,
        'íƒ€ì´ë² ì´': 2.5, 'í™ì½©': 3.5,
        'ê´Œ': 4.5, 'ì‚¬ì´íŒ': 4.5, 'í•˜ì™€ì´': 9, 'ì˜¤ì•„í›„': 9, 'í˜¸ë†€ë£°ë£¨': 9, 'ë§ˆìš°ì´': 9.5,
        'íŒŒë¦¬': 12, 'ëŸ°ë˜': 12, 'ë¡œë§ˆ': 11.5, 'ë°”ë¥´ì…€ë¡œë‚˜': 12,
        'ì´ìŠ¤íƒ„ë¶ˆ': 11,
        'ë‰´ìš•': 14, 'LA': 12,
        'ì‹œë“œë‹ˆ': 10.5,
        'í”„ë¼í•˜': 12, 'ë¹ˆ': 12, 'ì·¨ë¦¬íˆ': 12.5, 'ì•”ìŠ¤í…Œë¥´ë‹´': 11.5, 'ë®Œí—¨': 11.5,
        'í¬ë¼ë¹„': 6, 'í‘¸ì¼“': 6,
        'ì¹¸ì¿¤': 17, 'ëª°ë””ë¸Œ': 10,
        'ì œì£¼ë„': 1, 'ë¶€ì‚°': 0
      };
      const flightHours = flightHoursMap[matchedName] || null;
      let flightCost = 0;
      let flightUnknown = false;
      if (!needsCar) {
        if (flightPriceMap[matchedName] !== undefined) {
          flightCost = Math.round(flightPriceMap[matchedName] * flightMultiplier * typeDiscount);
        } else if (isJeju) {
          flightCost = Math.round(150000 * flightMultiplier);
        } else {
          // ë¯¸ë“±ë¡ ë„ì‹œëŠ” í•­ê³µë£Œ ë¯¸ì œê³µ (ë¶€ì •í™•í•œ ì •ë³´ ë°©ì§€)
          flightCost = 0;
          flightUnknown = true;
        }
      }

      const costs = {
        flight: flightCost,  // êµ­ë‚´(ì œì£¼ ì œì™¸)ëŠ” 0ì›
        car: needsCar ? fuelCost + totalToll : 0,  // ìë™ì°¨ ë¹„ìš© (ìœ ë¥˜ë¹„+í†¨ë¹„)
        hotel: Math.round((isDomestic ? 100000 : baseCost * 0.25) * hotelMultiplier * (simDays / 4) * typeDiscount),
        food: Math.round((isDomestic ? 50000 : 80000) * simDays * (simHotel === 'luxury' ? 1.5 : 1)),
        activity: Math.round((isDomestic ? 30000 : baseCost * 0.15) * (simDays / 4)),
        transport: needsCar ? 0 : Math.round(30000 * simDays),  // ìì°¨ì´ìš©ì‹œ í˜„ì§€êµí†µë¹„ 0
        insurance: isDomestic ? 0 : 15000,
        sim: isDomestic ? 0 : 12000,
        misc: Math.round((isDomestic ? 20000 : baseCost * 0.05) * simDays / 4)
      };
      const perPerson = Object.values(costs).reduce((a, b) => a + b, 0);
      const totalCost = perPerson * simTravelers;
      const usdRate = (window.__exchangeRates && window.__exchangeRates.USD) || 1300;
      const totalUSD = Math.round(totalCost / usdRate);

      // ëª©ì ì§€ ê¸°ë°˜ êµ¬ë§¤ ë§í¬ ìƒì„± (destName, countryëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨)
      const airportMap = {
        // ì¼ë³¸
        'ë„ì¿„': 'tyoa', 'ì˜¤ì‚¬ì¹´': 'osaa', 'í›„ì¿ ì˜¤ì¹´': 'fuk', 'ì‚¿í¬ë¡œ': 'spka', 'ì˜¤í‚¤ë‚˜ì™€': 'oka', 'ë‚˜ê³ ì•¼': 'ngoa', 'êµí† ': 'osaa', 'ë‚˜ë¼': 'osaa',
        // ë™ë‚¨ì•„
        'ë°©ì½•': 'bkka', 'ë‹¤ë‚­': 'dad', 'í˜¸ì¹˜ë¯¼': 'sgn', 'í•˜ë…¸ì´': 'han', 'ë‚˜íŠ¸ë‘': 'cam', 'í‘¸ê¾¸ì˜¥': 'pqc',
        'ì‹±ê°€í¬ë¥´': 'sina', 'ë°œë¦¬': 'dpsa', 'ìì¹´ë¥´íƒ€': 'jkta', 'ì„¸ë¶€': 'ceb', 'ë§ˆë‹ë¼': 'mnla', 'ë³´ë¼ì¹´ì´': 'mph',
        'í¬ë¼ë¹„': 'kbv', 'í‘¸ì¼“': 'hkta', 'ì¹˜ì•™ë§ˆì´': 'cnx', 'ì½”ì‚¬ë¬´ì´': 'usm',
        'ì¿ ì•Œë¼ë£¸í‘¸ë¥´': 'kula', 'ë‘ì¹´ìœ„': 'lgk', 'ì½”íƒ€í‚¤ë‚˜ë°œë£¨': 'bki',
        // ì¤‘í™”ê¶Œ
        'íƒ€ì´ë² ì´': 'tpet', 'í™ì½©': 'hkga', 'ë§ˆì¹´ì˜¤': 'mfm', 'ìƒí•˜ì´': 'shaa', 'ë² ì´ì§•': 'bjsa',
        // ëŒ€ì–‘ì£¼
        'ì‹œë“œë‹ˆ': 'syda', 'ë©œë²„ë¥¸': 'mela', 'ì˜¤í´ëœë“œ': 'akla', 'í€¸ìŠ¤íƒ€ìš´': 'zqn', 'í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜': 'chc', 'í”¼ì§€': 'nan',
        // ë¯¸ì£¼/íƒœí‰ì–‘
        'ê´Œ': 'gum', 'ì‚¬ì´íŒ': 'spn', 'í•˜ì™€ì´': 'hnla', 'í˜¸ë†€ë£°ë£¨': 'hnla',
        'ë‰´ìš•': 'nyca', 'LA': 'laxa', 'ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤': 'laxa', 'ìƒŒí”„ë€ì‹œìŠ¤ì½”': 'sfoa', 'ë¼ìŠ¤ë² ê°€ìŠ¤': 'lasa', 'ì‹œì¹´ê³ ': 'chia',
        'ì¹¸ì¿¤': 'cun', 'í† ë¡ í† ': 'ytoa', 'ë°´ì¿ ë²„': 'yvra',
        // ìœ ëŸ½
        'íŒŒë¦¬': 'pari', 'ëŸ°ë˜': 'lond', 'ë¡œë§ˆ': 'rome', 'ë°”ë¥´ì…€ë¡œë‚˜': 'bcna', 'ë§ˆë“œë¦¬ë“œ': 'mada',
        'í”„ë¼í•˜': 'prga', 'ë¹ˆ': 'viea', 'ì·¨ë¦¬íˆ': 'zrha', 'ì•”ìŠ¤í…Œë¥´ë‹´': 'amsa', 'ë®Œí—¨': 'muea',
        'ì´ìŠ¤íƒ„ë¶ˆ': 'ista', 'ì•„í…Œë„¤': 'atha', 'ë¦¬ìŠ¤ë³¸': 'lisa', 'ë”ë¸”ë¦°': 'duba',
        'ë¶€ë‹¤í˜ìŠ¤íŠ¸': 'buda', 'ë°”ë¥´ìƒ¤ë°”': 'wawa', 'í—¬ì‹±í‚¤': 'hela', 'ìŠ¤í†¡í™€ë¦„': 'stoa',
        'ë°€ë¼ë…¸': 'mila', 'ë² ë„¤ì¹˜ì•„': 'vcea', 'í”¼ë Œì²´': 'flra', 'ë‹ˆìŠ¤': 'ncea',
        'ë‘ë¸Œë¡œë¸Œë‹ˆí¬': 'dbva', 'ì‚°í† ë¦¬ë‹ˆ': 'jtr', 'ë ˆì´ìº¬ë¹„í¬': 'reya', 'ë² ë¥¼ë¦°': 'bera',
        // ì¤‘ë™/ì•„í”„ë¦¬ì¹´
        'ë‘ë°”ì´': 'dxba', 'ëª°ë””ë¸Œ': 'mlea', 'ì¹´ì´ë¡œ': 'caia', 'ì¼€ì´í”„íƒ€ìš´': 'cpta',
        // êµ­ë‚´
        'ë¶€ì‚°': 'pus', 'ì œì£¼': 'cju', 'ì œì£¼ë„': 'cju'
      };
      const airportCode = airportMap[matchedName] || null;

      const bookingLinks = [
        { icon: 'âœˆï¸', label: 'í•­ê³µê¶Œ ê²€ìƒ‰', desc: 'ìŠ¤ì¹´ì´ìŠ¤ìºë„ˆì—ì„œ ìµœì €ê°€ í•­ê³µê¶Œ', url: airportCode ? `https://www.skyscanner.co.kr/transport/flights/icn/${airportCode}/` : `https://www.skyscanner.co.kr/transport/flights-from/icn/`, color: 'blue' },
        { icon: 'âœˆï¸', label: 'ë„¤ì´ë²„ í•­ê³µ', desc: 'ë„¤ì´ë²„ í•­ê³µê¶Œ ë¹„êµ', url: `https://flight.naver.com/`, color: 'green' },
        { icon: 'ğŸ¨', label: 'í˜¸í…” ê²€ìƒ‰', desc: 'ë¶€í‚¹ë‹·ì»´ì—ì„œ ìˆ™ì†Œ ë¹„êµ', url: `https://www.booking.com/searchresults.ko.html?ss=${encodeURIComponent(destName)}`, color: 'blue' },
        { icon: 'ğŸ¨', label: 'ì•„ê³ ë‹¤', desc: 'ì•„ì‹œì•„ íŠ¹ê°€ ìˆ™ì†Œ', url: `https://www.agoda.com/ko-kr/search?city=${encodeURIComponent(destName)}`, color: 'red' },
        { icon: 'ğŸ ', label: 'ì—ì–´ë¹„ì•¤ë¹„', desc: 'í˜„ì§€ ìˆ™ì†Œ ì²´í—˜', url: `https://www.airbnb.co.kr/s/${encodeURIComponent(destName)}/homes`, color: 'pink' },
        { icon: 'ğŸ“¦', label: 'íŒ¨í‚¤ì§€ ê²€ìƒ‰', desc: 'í•˜ë‚˜íˆ¬ì–´ íŒ¨í‚¤ì§€ ìƒí’ˆ', url: `https://www.hanatour.com/search?keyword=${encodeURIComponent(destName)}`, color: 'orange' },
        { icon: 'ğŸ“¦', label: 'ëª¨ë‘íˆ¬ì–´', desc: 'íŒ¨í‚¤ì§€ ìƒí’ˆ ë¹„êµ', url: `https://www.modetour.com/search?keyword=${encodeURIComponent(destName)}`, color: 'purple' }
      ];

      // ìµœì €ê°€ ê²€ìƒ‰ ë§í¬ (ì‹¤ì œ ê²€ìƒ‰ ì‚¬ì´íŠ¸ë¡œ ì—°ê²°)
      const searchLinks = [
        { id: 1, icon: 'âœˆï¸', title: `ì¸ì²œâ†’${destName} í•­ê³µê¶Œ ê²€ìƒ‰`, desc: 'ìŠ¤ì¹´ì´ìŠ¤ìºë„ˆì—ì„œ ìµœì €ê°€ ë¹„êµ', url: bookingLinks[0].url, site: 'Skyscanner' },
        { id: 2, icon: 'âœˆï¸', title: `ì¸ì²œâ†’${destName} í•­ê³µê¶Œ`, desc: 'ë„¤ì´ë²„ í•­ê³µê¶Œ ê°€ê²© ë¹„êµ', url: bookingLinks[1].url, site: 'Naver' },
        { id: 3, icon: 'ğŸ¨', title: `${destName} ìˆ™ì†Œ ê²€ìƒ‰`, desc: 'ë¶€í‚¹ë‹·ì»´ì—ì„œ í˜¸í…” ë¹„êµ', url: bookingLinks[2].url, site: 'Booking.com' }
      ];

      const colorMap = { blue: 'bg-blue-50 border-blue-200 text-blue-700', green: 'bg-green-50 border-green-200 text-green-700', red: 'bg-red-50 border-red-200 text-red-700', pink: 'bg-pink-50 border-pink-200 text-pink-700', orange: 'bg-orange-50 border-orange-200 text-orange-700', purple: 'bg-purple-50 border-purple-200 text-purple-700' };

      return (
        <div className="p-4 space-y-4">
          {/* ì‹œë®¬ë ˆì´ì…˜ ì¡°ê±´ */}
          <div className="bg-white rounded-xl border border-gray-200 p-3">
            <h3 className="text-sm font-bold mb-3">ğŸ§® ë¹„ìš© ì‹œë®¬ë ˆì´ì…˜</h3>
            <div className="grid grid-cols-2 gap-2 mb-3">
              <div>
                <label className="text-[10px] text-gray-500">ì¸ì›</label>
                <div className="flex items-center gap-1">
                  <button onClick={() => setSimTravelers(Math.max(1, simTravelers - 1))} className="w-7 h-7 rounded bg-gray-100 text-sm">-</button>
                  <span className="text-sm font-bold w-8 text-center">{simTravelers}ëª…</span>
                  <button onClick={() => setSimTravelers(simTravelers + 1)} className="w-7 h-7 rounded bg-gray-100 text-sm">+</button>
                </div>
              </div>
              <div>
                <label className="text-[10px] text-gray-500">ê¸°ê°„</label>
                <div className="flex items-center gap-1">
                  <button onClick={() => setSimDays(Math.max(2, simDays - 1))} className="w-7 h-7 rounded bg-gray-100 text-sm">-</button>
                  <span className="text-sm font-bold w-8 text-center">{simDays}ì¼</span>
                  <button onClick={() => setSimDays(simDays + 1)} className="w-7 h-7 rounded bg-gray-100 text-sm">+</button>
                </div>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-1.5 mb-3">
              {[{v:'package',l:'íŒ¨í‚¤ì§€'},{v:'free',l:'ììœ ì—¬í–‰'}].map(t => (
                <button key={t.v} onClick={() => setSimType(t.v)}
                  className={`text-xs py-1.5 rounded-lg border ${simType === t.v ? 'bg-primary-600 text-white border-primary-600' : 'bg-white border-gray-200'}`}>
                  {t.l}
                </button>
              ))}
            </div>
            <div className="grid grid-cols-2 gap-2 mb-3">
              {!needsCar && (
                <div>
                  <label className="text-[10px] text-gray-500">í•­ê³µ ì¢Œì„</label>
                  <div className="flex gap-1">
                    {[{v:'economy',l:'ì´ì½”ë…¸ë¯¸'},{v:'business',l:'ë¹„ì¦ˆë‹ˆìŠ¤'}].map(c => (
                      <button key={c.v} onClick={() => setSimClass(c.v)}
                        className={`text-[10px] flex-1 py-1 rounded border ${simClass === c.v ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-200'}`}>
                        {c.l}
                      </button>
                    ))}
                  </div>
                </div>
              )}
              <div className={needsCar ? 'col-span-2' : ''}>
                <label className="text-[10px] text-gray-500">ìˆ™ì†Œ ë“±ê¸‰</label>
                <div className="flex gap-1">
                  {[{v:'budget',l:'ì €ê°€'},{v:'mid',l:'ì¤‘ê¸‰'},{v:'luxury',l:'ê³ ê¸‰'}].map(h => (
                    <button key={h.v} onClick={() => setSimHotel(h.v)}
                      className={`text-[10px] flex-1 py-1 rounded border ${simHotel === h.v ? 'bg-purple-600 text-white border-purple-600' : 'bg-white border-gray-200'}`}>
                      {h.l}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* ì „ì—­ ì„¤ì • ì„¹ì…˜ */}
            <div className="bg-gray-50 rounded-lg p-2 mb-3">
              <div className="flex items-center justify-between mb-2">
                <span className="text-xs font-bold text-gray-700">âš™ï¸ ì—¬í–‰ ì„¤ì •</span>
                <button onClick={() => setShowSettings(!showSettings)} className="text-[10px] text-gray-600 underline">
                  {showSettings ? 'ì ‘ê¸°' : 'ì„¤ì • ë³€ê²½'}
                </button>
              </div>
              {showSettings && (
                <div className="grid grid-cols-3 gap-2 mb-2">
                  <div>
                    <label className="text-[10px] text-gray-500">ì¸ì›ìˆ˜</label>
                    <input type="number" value={simTravelers} onChange={(e) => setSimTravelers(Number(e.target.value) || 2)}
                      className="w-full text-xs p-1.5 border rounded" min="1" max="20" />
                  </div>
                  <div>
                    <label className="text-[10px] text-gray-500">ì—°ë¹„ (km/L)</label>
                    <input type="number" value={fuelEfficiency} onChange={(e) => setFuelEfficiency(Number(e.target.value) || 10)}
                      className="w-full text-xs p-1.5 border rounded" min="5" max="25" />
                  </div>
                  <div>
                    <label className="text-[10px] text-gray-500">ìœ ê°€ (ì›/L)</label>
                    <input type="number" value={fuelPrice} onChange={(e) => setFuelPrice(Number(e.target.value) || 1700)}
                      className="w-full text-xs p-1.5 border rounded" min="1000" max="3000" step="100" />
                  </div>
                </div>
              )}
              <div className="text-[10px] text-gray-500">
                ğŸ‘¤ {simTravelers}ëª… | ğŸš— ì—°ë¹„ {fuelEfficiency}km/L | â›½ {fuelPrice.toLocaleString()}ì›/L
              </div>
            </div>

            {/* êµ­ë‚´ ìë™ì°¨ ì—¬í–‰ ë¹„ìš© ì •ë³´ */}
            {needsCar && (
              <div className="bg-blue-50 rounded-lg p-2 mb-3">
                <div className="text-xs font-bold text-blue-700 mb-1">ğŸš— ìë™ì°¨ ì—¬í–‰ ë¹„ìš©</div>
                <div className="text-[10px] text-blue-600">
                  ì„œìš¸ â†’ {destName}: ì™•ë³µ {(distance * 2).toLocaleString()}km | ìœ ë¥˜ë¹„ {formatCurrency(fuelCost)} + í†¨ë¹„ {formatCurrency(totalToll)}
                </div>
              </div>
            )}

            {/* ë¹„ìš© ê²°ê³¼ */}
            <div className="bg-gradient-to-r from-primary-50 to-purple-50 rounded-lg p-3 mb-2">
              <div className="flex justify-between items-end mb-2">
                <span className="text-xs text-gray-500">ì´ ì˜ˆìƒë¹„ìš© ({simTravelers}ì¸)</span>
                <div className="text-right">
                  <span className="text-lg font-black text-primary-700">{formatCurrency(totalCost)}</span>
                  <span className="block text-[10px] text-gray-400">${totalUSD.toLocaleString()} USD</span>
                </div>
              </div>
              <span className="text-[10px] text-gray-400">1ì¸ {formatCurrency(perPerson)} (${Math.round(perPerson / usdRate).toLocaleString()})</span>
            </div>

            {/* í•­ëª©ë³„ ìƒì„¸ */}
            <div className="space-y-1">
              {[
                { label: flightUnknown ? 'âœˆï¸ í•­ê³µ (ìŠ¤ì¹´ì´ìŠ¤ìºë„ˆì—ì„œ ê²€ìƒ‰í•˜ì„¸ìš”)' : `âœˆï¸ í•­ê³µ (ì™•ë³µ${flightHours ? `, í¸ë„ ${flightHours % 1 === 0 ? flightHours + 'ì‹œê°„' : Math.floor(flightHours) + 'ì‹œê°„ ' + Math.round((flightHours % 1) * 60) + 'ë¶„'}` : ''})`, cost: costs.flight, show: !needsCar, isUnknown: flightUnknown },
                { label: 'ğŸš— ìë™ì°¨ (ìœ ë¥˜ë¹„+í†¨ë¹„)', cost: costs.car, show: needsCar, isCarCost: true },
                { label: 'ğŸ¨ ìˆ™ì†Œ', cost: costs.hotel, show: true },
                { label: 'ğŸ½ï¸ ì‹ë¹„', cost: costs.food, show: true },
                { label: 'ğŸ¯ í™œë™', cost: costs.activity, show: true },
                { label: 'ğŸš• í˜„ì§€êµí†µ', cost: costs.transport, show: !needsCar && costs.transport > 0 },
                { label: 'ğŸ›¡ï¸ ë³´í—˜', cost: costs.insurance, show: costs.insurance > 0 },
                { label: 'ğŸ“± ìœ ì‹¬', cost: costs.sim, show: costs.sim > 0 },
                { label: 'ğŸ ê¸°íƒ€', cost: costs.misc, show: true }
              ].filter(item => item.show).map((item, i) => (
                <div key={i} className="flex justify-between text-xs py-1 border-b border-gray-50">
                  <span className="text-gray-600">{item.label}</span>
                  <div className="text-right">
                    <span className="font-medium">{formatCurrency(item.isCarCost ? item.cost : item.cost * simTravelers)}</span>
                    {!item.isCarCost && <span className="text-[10px] text-gray-400 ml-1">(1ì¸ {formatCurrency(item.cost)})</span>}
                    {item.isCarCost && <span className="text-[10px] text-gray-400 ml-1">(ì „ì²´)</span>}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* ê°€ê²© ì•Œë¦¼ */}
          <div className="bg-white rounded-xl border border-gray-200 p-3">
            <h3 className="text-sm font-bold mb-3">ğŸ” ìµœì €ê°€ ê²€ìƒ‰</h3>
            <div className="space-y-2">
              {searchLinks.map(link => (
                <a key={link.id} href={link.url} target="_blank" rel="noopener noreferrer"
                  className="block bg-blue-50 border border-blue-200 rounded-lg p-3 hover:bg-blue-100 transition-colors">
                  <div className="flex items-center justify-between">
                    <div>
                      <span className="text-sm font-bold text-blue-800">{link.icon} {link.title}</span>
                      <p className="text-[10px] text-blue-500 mt-0.5">{link.desc}</p>
                    </div>
                    <span className="text-xs text-blue-400">ê²€ìƒ‰ â†’</span>
                  </div>
                </a>
              ))}
            </div>
            <p className="text-[10px] text-gray-400 text-center mt-2">ì‹¤ì œ ì˜ˆì•½ ì‚¬ì´íŠ¸ì—ì„œ í˜„ì¬ ê°€ê²©ì„ í™•ì¸í•˜ì„¸ìš”</p>
          </div>

          {/* êµ¬ë§¤ ì—°ê³„ ë§í¬ */}
          <div className="bg-white rounded-xl border border-gray-200 p-3">
            <h3 className="text-sm font-bold mb-3">ğŸ›’ ë°”ë¡œ ì˜ˆì•½í•˜ê¸°</h3>
            <div className="space-y-2">
              {bookingLinks.map((link, i) => (
                <a key={i} href={link.url} target="_blank" rel="noopener noreferrer"
                  className={`flex items-center gap-3 p-2.5 rounded-lg border hover:shadow-sm transition-all ${colorMap[link.color] || 'bg-gray-50 border-gray-200'}`}>
                  <span className="text-xl">{link.icon}</span>
                  <div className="flex-1 min-w-0">
                    <p className="text-xs font-bold">{link.label}</p>
                    <p className="text-[10px] opacity-75">{link.desc}</p>
                  </div>
                  <span className="text-xs opacity-50">â†’</span>
                </a>
              ))}
            </div>
          </div>

          <p className="text-[10px] text-gray-400 text-center pb-4">
            * ì˜ˆìƒë¹„ìš©ì€ AI ì¶”ì •ì¹˜ì´ë©° ì‹¤ì œ ê°€ê²©ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br/>
            * êµ¬ë§¤ ë§í¬ í´ë¦­ ì‹œ ì™¸ë¶€ ì‚¬ì´íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤
          </p>
        </div>
      );
    }

    // â”€â”€â”€ ë¹„ìƒ ëŒ€ì²˜ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function EmergencyTab({ project }) {
      const dest = project.destination;
      const country = dest?.country || '';

      // êµ­ê°€ë³„ ë¹„ìƒ ì—°ë½ì²˜ DB (í™•ì¥: 40ê°œêµ­+)
      const emergencyDB = {
        'ì¼ë³¸': { police: '110', ambulance: '119', fire: '119', embassy: '03-3452-7611', embassyAddr: 'ë„ì¿„ ë¯¸ë‚˜í† êµ¬ ë¯¸ë‚˜ë¯¸ì•„ìë¶€ 1-2-5', currency: 'JPY' },
        'íƒœêµ­': { police: '191', ambulance: '1669', fire: '199', embassy: '02-247-7537', embassyAddr: 'ë°©ì½• ìˆ˜ì¿¤ë¹— 23', currency: 'THB' },
        'ë² íŠ¸ë‚¨': { police: '113', ambulance: '115', fire: '114', embassy: '024-3831-5110', embassyAddr: 'í•˜ë…¸ì´ ë°”ë”˜êµ°', currency: 'VND' },
        'í”„ë‘ìŠ¤': { police: '17', ambulance: '15', fire: '18', embassy: '01-4753-0101', embassyAddr: 'íŒŒë¦¬ 125 rue de Grenelle', currency: 'EUR' },
        'ì¸ë„ë„¤ì‹œì•„': { police: '110', ambulance: '118', fire: '113', embassy: '021-2967-2555', embassyAddr: 'ìì¹´ë¥´íƒ€ Jl. Jend. Gatot Subroto', currency: 'IDR' },
        'ì‹±ê°€í¬ë¥´': { police: '999', ambulance: '995', fire: '995', embassy: '6256-1188', embassyAddr: 'ì‹±ê°€í¬ë¥´ 47 Scotts Road', currency: 'SGD' },
        'ë¯¸êµ­': { police: '911', ambulance: '911', fire: '911', embassy: '202-939-5600', embassyAddr: 'ì›Œì‹±í„´ DC 2450 Massachusetts Ave', currency: 'USD' },
        'íŠ€ë¥´í‚¤ì˜ˆ': { police: '155', ambulance: '112', fire: '110', embassy: '0312-468-4823', embassyAddr: 'ì•™ì¹´ë¼ Resit Galip Cad. No.70', currency: 'TRY' },
        'ê·¸ë¦¬ìŠ¤': { police: '100', ambulance: '166', fire: '199', embassy: '210-698-4080', embassyAddr: 'ì•„í…Œë„¤ Eratosthenous 1', currency: 'EUR' },
        'ì¤‘êµ­': { police: '110', ambulance: '120', fire: '119', embassy: '010-6532-0290', embassyAddr: 'ë² ì´ì§• ì°¨ì˜¤ì–‘êµ¬', currency: 'CNY' },
        'ëŒ€ë§Œ': { police: '110', ambulance: '119', fire: '119', embassy: '02-2758-8320', embassyAddr: 'íƒ€ì´ë² ì´ ê¸°ë¥­ë¡œ 333í˜¸', currency: 'TWD' },
        'í™ì½©': { police: '999', ambulance: '999', fire: '999', embassy: '2529-4141', embassyAddr: 'í™ì½© Central 5/F', currency: 'HKD' },
        'í•„ë¦¬í•€': { police: '117', ambulance: '911', fire: '911', embassy: '02-8856-9210', embassyAddr: 'ë§ˆë‹ë¼ ë§ˆì¹´í‹°', currency: 'PHP' },
        'ë§ë ˆì´ì‹œì•„': { police: '999', ambulance: '999', fire: '994', embassy: '03-4251-2336', embassyAddr: 'ì¿ ì•Œë¼ë£¸í‘¸ë¥´ Jalan Nipah', currency: 'MYR' },
        'ìº„ë³´ë””ì•„': { police: '117', ambulance: '119', fire: '118', embassy: '023-211-163', embassyAddr: 'í”„ë†ˆíœ Blvd. Sothearos', currency: 'KHR' },
        'ì¸ë„': { police: '100', ambulance: '102', fire: '101', embassy: '011-2688-4257', embassyAddr: 'ë‰´ë¸ë¦¬ Chandragupta Marg', currency: 'INR' },
        'í˜¸ì£¼': { police: '000', ambulance: '000', fire: '000', embassy: '02-6270-4100', embassyAddr: 'ìº”ë²„ë¼ 113 Empire Circuit', currency: 'AUD' },
        'ë‰´ì§ˆëœë“œ': { police: '111', ambulance: '111', fire: '111', embassy: '04-473-9073', embassyAddr: 'ì›°ë§í„´ 11th Floor ASB Bank Tower', currency: 'NZD' },
        'ì˜êµ­': { police: '999', ambulance: '999', fire: '999', embassy: '020-7227-5500', embassyAddr: 'ëŸ°ë˜ 60 Buckingham Gate', currency: 'GBP' },
        'ë…ì¼': { police: '110', ambulance: '112', fire: '112', embassy: '030-260-650', embassyAddr: 'ë² ë¥¼ë¦° StÃ¼lerstraÃŸe 8-10', currency: 'EUR' },
        'ì´íƒˆë¦¬ì•„': { police: '113', ambulance: '118', fire: '115', embassy: '06-802-461', embassyAddr: 'ë¡œë§ˆ Via Barnaba Oriani 30', currency: 'EUR' },
        'ìŠ¤í˜ì¸': { police: '091', ambulance: '112', fire: '080', embassy: '91-353-2000', embassyAddr: 'ë§ˆë“œë¦¬ë“œ Calle de GonzÃ¡lez AmigÃ³ 15', currency: 'EUR' },
        'ìŠ¤ìœ„ìŠ¤': { police: '117', ambulance: '144', fire: '118', embassy: '031-356-2444', embassyAddr: 'ë² ë¥¸ Kalcheggweg 38', currency: 'CHF' },
        'ë„¤ëœë€ë“œ': { police: '112', ambulance: '112', fire: '112', embassy: '070-740-0200', embassyAddr: 'í—¤ì´ê·¸ Verlengde Tolweg 8', currency: 'EUR' },
        'ì²´ì½”': { police: '158', ambulance: '155', fire: '150', embassy: '234-090-411', embassyAddr: 'í”„ë¼í•˜ SlavÃ­Äkova 5', currency: 'CZK' },
        'ìºë‚˜ë‹¤': { police: '911', ambulance: '911', fire: '911', embassy: '613-244-5010', embassyAddr: 'ì˜¤íƒ€ì™€ 150 Boteler St', currency: 'CAD' },
        'ë©•ì‹œì½”': { police: '911', ambulance: '911', fire: '911', embassy: '55-5202-9866', embassyAddr: 'ë©•ì‹œì½”ì‹œí‹° Lope de Armendariz 110', currency: 'MXN' },
        'ë¸Œë¼ì§ˆ': { police: '190', ambulance: '192', fire: '193', embassy: '61-3321-2500', embassyAddr: 'ë¸Œë¼ì§ˆë¦¬ì•„ SEN 801', currency: 'BRL' },
        'ëŸ¬ì‹œì•„': { police: '102', ambulance: '103', fire: '101', embassy: '495-783-2727', embassyAddr: 'ëª¨ìŠ¤í¬ë°” Plyushchikha ul. 56', currency: 'RUB' },
        'ì•„ëì—ë¯¸ë¦¬íŠ¸': { police: '999', ambulance: '998', fire: '997', embassy: '02-693-3556', embassyAddr: 'ì•„ë¶€ë‹¤ë¹„', currency: 'AED' },
        'ì´ì§‘íŠ¸': { police: '122', ambulance: '123', fire: '180', embassy: '02-3761-1234', embassyAddr: 'ì¹´ì´ë¡œ Dokki', currency: 'EGP' },
        'ëª½ê³¨': { police: '102', ambulance: '103', fire: '101', embassy: '011-321-548', embassyAddr: 'ìš¸ë€ë°”í† ë¥´', currency: 'MNT' },
        'ë¼ì˜¤ìŠ¤': { police: '191', ambulance: '195', fire: '190', embassy: '021-352-031', embassyAddr: 'ë¹„ì—”í‹°ì•ˆ', currency: 'LAK' },
        'ë¯¸ì–€ë§ˆ': { police: '199', ambulance: '192', fire: '191', embassy: '01-527-142', embassyAddr: 'ì–‘ê³¤', currency: 'MMK' },
        'ë„¤íŒ”': { police: '100', ambulance: '102', fire: '101', embassy: '01-427-0172', embassyAddr: 'ì¹´íŠ¸ë§Œë‘', currency: 'NPR' },
        'ëª¨ë¡œì½”': { police: '190', ambulance: '150', fire: '150', embassy: '0537-751-767', embassyAddr: 'ë¼ë°”íŠ¸', currency: 'MAD' },
        'ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­': { police: '10111', ambulance: '10177', fire: '10177', embassy: '012-460-2508', embassyAddr: 'í”„ë¦¬í† ë¦¬ì•„', currency: 'ZAR' },
        'í¬ë¡œì•„í‹°ì•„': { police: '192', ambulance: '194', fire: '193', embassy: '01-481-8282', embassyAddr: 'ìê·¸ë ˆë¸Œ', currency: 'EUR' },
        'í—ê°€ë¦¬': { police: '107', ambulance: '104', fire: '105', embassy: '1-462-3080', embassyAddr: 'ë¶€ë‹¤í˜ìŠ¤íŠ¸', currency: 'HUF' },
        'í´ë€ë“œ': { police: '997', ambulance: '999', fire: '998', embassy: '22-559-2900', embassyAddr: 'ë°”ë¥´ìƒ¤ë°”', currency: 'PLN' },
        'í•œêµ­': { police: '112', ambulance: '119', fire: '119', embassy: '-', embassyAddr: '-', currency: 'KRW' },
        'ëŒ€í•œë¯¼êµ­': { police: '112', ambulance: '119', fire: '119', embassy: '-', embassyAddr: '-', currency: 'KRW' }
      };

      const info = emergencyDB[country] || { police: 'í˜„ì§€ í™•ì¸ í•„ìš”', ambulance: 'í˜„ì§€ í™•ì¸ í•„ìš”', fire: 'í˜„ì§€ í™•ì¸ í•„ìš”', embassy: 'ì™¸êµë¶€ +82-2-2100-2114', embassyAddr: 'ì¶œêµ­ ì „ í™•ì¸', currency: 'USD' };

      const sections = [
        {
          title: 'ê¸´ê¸‰ ì „í™”ë²ˆí˜¸',
          icon: 'ğŸ“',
          items: [
            { label: `í˜„ì§€ ê²½ì°° (${country})`, value: info.police, action: `tel:${info.police}` },
            { label: 'í˜„ì§€ ì‘ê¸‰ì˜ë£Œ', value: info.ambulance, action: `tel:${info.ambulance}` },
            { label: 'í˜„ì§€ í™”ì¬ì‹ ê³ ', value: info.fire, action: `tel:${info.fire}` },
            { label: 'ì˜ì‚¬ì½œì„¼í„° (24ì‹œê°„)', value: '+82-2-3210-0404', action: 'tel:+82-2-3210-0404' },
            { label: 'í•´ì™¸ ê¸´ê¸‰ì „í™”', value: '+82-2-2100-2114', action: 'tel:+82-2-2100-2114' }
          ]
        },
        {
          title: 'ëŒ€í•œë¯¼êµ­ ëŒ€ì‚¬ê´€/ì˜ì‚¬ê´€',
          icon: 'ğŸ›ï¸',
          items: [
            { label: 'ëŒ€ì‚¬ê´€ ì „í™”', value: info.embassy, action: `tel:${info.embassy}` },
            { label: 'ì£¼ì†Œ', value: info.embassyAddr },
            { label: 'ì™¸êµë¶€ í•´ì™¸ì•ˆì „ì—¬í–‰', value: 'www.0404.go.kr', action: 'https://www.0404.go.kr' }
          ]
        },
        {
          title: 'ì˜ë£Œ ì‘ê¸‰ìƒí™©',
          icon: 'ğŸ¥',
          items: [
            { label: 'í˜„ì§€ êµ¬ê¸‰ì°¨', value: info.ambulance, action: `tel:${info.ambulance}` },
            { label: 'ì—¬í–‰ìë³´í—˜ ê¸´ê¸‰ì—°ë½', value: 'ë³´í—˜ì‚¬ ì•± í™•ì¸', note: 'ë³´í—˜ì¦ê¶Œ ë²ˆí˜¸ ì €ì¥ í•„ìˆ˜' },
            { label: 'ì•½êµ­ (í•„ìˆ˜ ìƒë¹„ì•½)', value: 'í•´ì—´ì œ, ì†Œí™”ì œ, ì§€ì‚¬ì œ, ë°´ë“œ, ìƒì²˜ì—°ê³ ' }
          ]
        },
        {
          title: 'ë¶„ì‹¤/ë„ë‚œ ëŒ€ì²˜',
          icon: 'ğŸ”',
          items: [
            { label: 'ì—¬ê¶Œ ë¶„ì‹¤', value: 'ëŒ€ì‚¬ê´€ ì—°ë½ â†’ ì—¬í–‰ì¦ëª…ì„œ ë°œê¸‰', note: 'ì—¬ê¶Œ ì‚¬ë³¸ + ì‚¬ì§„ 2ë§¤ ì¤€ë¹„' },
            { label: 'ì¹´ë“œ ë¶„ì‹¤', value: 'ì¹´ë“œì‚¬ ì¦‰ì‹œ ë¶„ì‹¤ì‹ ê³ ' },
            { label: 'ì‚¼ì„±ì¹´ë“œ', value: '1588-8700', action: 'tel:1588-8700' },
            { label: 'ì‹ í•œì¹´ë“œ', value: '1544-7000', action: 'tel:1544-7000' },
            { label: 'í˜„ê¸ˆ ì†Œì§„', value: 'ì›¨ìŠ¤í„´ìœ ë‹ˆì˜¨ / ëŒ€ì‚¬ê´€ ê¸´ê¸‰ ëŒ€ë¶€' }
          ]
        },
        {
          title: 'ê²°ì œ & í™˜ì „ íŒ',
          icon: 'ğŸ’³',
          items: [
            { label: 'ì¹´ë“œ ê²°ì œ', value: 'í•´ì™¸ê²°ì œ ìˆ˜ìˆ˜ë£Œ 1-2% (íŠ¸ë˜ë¸” ì¹´ë“œ ì¶”ì²œ)' },
            { label: 'íŠ¸ë˜ë¸” ì¹´ë“œ', value: 'íŠ¸ë˜ë¸”ì›”ë ›, í•˜ë‚˜ íŠ¸ë˜ë¸”ë¡œê·¸, ìš°ë¦¬ WON', note: 'í˜„ì§€ í†µí™” ì¶©ì „ â†’ ìˆ˜ìˆ˜ë£Œ ì ˆì•½' },
            { label: 'í˜„ê¸ˆ', value: 'ì†Œì•¡ í˜„ê¸ˆ ì¤€ë¹„ (íƒì‹œ, ì‹œì¥, íŒìš©)', note: 'ì´ ì˜ˆì‚°ì˜ 10-15% ê¶Œì¥' },
            { label: 'ATM ì¸ì¶œ', value: 'êµ­ì œ ë„¤íŠ¸ì›Œí¬ ATM (PLUS/Cirrus)', note: 'ê±´ë‹¹ ìˆ˜ìˆ˜ë£Œ í™•ì¸' }
          ]
        }
      ];

      return (
        <div className="p-4 space-y-4">
          <div className="bg-red-50 border border-red-200 rounded-xl p-3 text-center">
            <p className="text-sm font-bold text-red-700">ğŸ†˜ {dest?.flag} {country} ë¹„ìƒ ëŒ€ì²˜ ê°€ì´ë“œ</p>
            <p className="text-xs text-red-500 mt-1">ì¶œêµ­ ì „ ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ê¶Œì¥ (ì˜¤í”„ë¼ì¸ ì‚¬ìš©)</p>
          </div>

          {/* ë¹„ì ì •ë³´ */}
          <VisaWidget country={country} />

          {sections.map((section, si) => (
            <div key={si} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
              <div className="bg-gray-50 px-3 py-2 border-b">
                <span className="text-sm font-bold">{section.icon} {section.title}</span>
              </div>
              <div className="divide-y">
                {section.items.map((item, ii) => (
                  <div key={ii} className="px-3 py-2.5 flex items-center justify-between">
                    <div className="flex-1 min-w-0">
                      <p className="text-xs text-gray-500">{item.label}</p>
                      <p className="text-sm font-medium text-gray-900 truncate">{item.value}</p>
                      {item.note && <p className="text-[10px] text-orange-500 mt-0.5">{item.note}</p>}
                    </div>
                    {item.action && (
                      <a href={item.action} target={item.action.startsWith('http') ? '_blank' : undefined} rel="noopener noreferrer"
                        className="ml-2 flex-shrink-0 bg-primary-100 text-primary-700 text-xs px-2.5 py-1.5 rounded-lg font-medium hover:bg-primary-200">
                        {item.action.startsWith('tel:') ? 'ğŸ“ ì „í™”' : 'ğŸ”— ì—´ê¸°'}
                      </a>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))}

          <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
            <p className="text-xs font-bold text-blue-700 mb-1">ğŸ“‹ ì¶œêµ­ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>
            <ul className="text-xs text-blue-600 space-y-1">
              <li>- ì—¬ê¶Œ ì‚¬ë³¸ (ì•± & í´ë¼ìš°ë“œ ì €ì¥)</li>
              <li>- ì—¬ê¶Œ ì‚¬ì§„ 2ë§¤ (ëŒ€ì‚¬ê´€ ì—¬í–‰ì¦ëª…ì„œìš©)</li>
              <li>- ë³´í—˜ì¦ê¶Œ ë²ˆí˜¸ ë©”ëª¨</li>
              <li>- ì¹´ë“œì‚¬ í•´ì™¸ë¶„ì‹¤ ì „í™”ë²ˆí˜¸ ì €ì¥</li>
              <li>- ì´ í˜ì´ì§€ ìŠ¤í¬ë¦°ìƒ· ì €ì¥</li>
              <li>- ì˜¤í”„ë¼ì¸ ì§€ë„ ë‹¤ìš´ë¡œë“œ (Google Maps)</li>
            </ul>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ê³µìœ  íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ShareTab({ project, itinerary, state }) {
      const [shareUrl, setShareUrl] = useState(null);
      const [sharing, setSharing] = useState(false);
      const [copied, setCopied] = useState(false);
      const [shareMethod, setShareMethod] = useState(null);

      const createShareLink = async () => {
        setSharing(true);
        const result = await api('/api/share/create', {
          method: 'POST',
          body: JSON.stringify({ project, itinerary })
        });
        if (result) {
          const fullUrl = `${window.location.origin}?shared=${result.shareId}`;
          setShareUrl(fullUrl);
        }
        setSharing(false);
      };

      const copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        }
      };

      const shareVia = (method) => {
        if (!shareUrl) return;
        const text = `${project.title} ì—¬í–‰ ê³„íšì„ ê³µìœ í•©ë‹ˆë‹¤! âœˆï¸`;
        const encodedText = encodeURIComponent(text);
        const encodedUrl = encodeURIComponent(shareUrl);

        const urls = {
          kakao: `https://sharer.kakao.com/talk/friends/picker/link?url=${encodedUrl}&text=${encodedText}`,
          line: `https://social-plugins.line.me/lineit/share?url=${encodedUrl}`,
          sms: `sms:?body=${encodedText}%20${encodedUrl}`,
          email: `mailto:?subject=${encodedText}&body=${encodedText}%0A%0A${encodedUrl}`
        };

        if (urls[method]) window.open(urls[method], '_blank');
      };

      // í…ìŠ¤íŠ¸ ìš”ì•½ ìƒì„± (ë©”ì‹ ì € ê³µìœ ìš©)
      const generateTextSummary = () => {
        let text = `âœˆï¸ ${project.title}\n`;
        text += `ğŸ“… ${project.dates?.start || 'TBD'} ${getDDay(project.dates?.start)}\n`;
        text += `ğŸ‘¥ ${project.travelers}ëª…\n`;
        text += `ğŸ’° ì˜ˆì‚°: ${formatCurrency(project.budget.total)}\n\n`;

        if (itinerary) {
          text += `ğŸ“‹ ì¼ì • ìš”ì•½:\n`;
          itinerary.days.forEach(d => {
            text += `Day${d.dayNumber}: ${d.title}\n`;
            d.slots.slice(0, 3).forEach(s => {
              text += `  ${s.time} ${s.icon} ${s.title}\n`;
            });
            if (d.slots.length > 3) text += `  ... ì™¸ ${d.slots.length - 3}ê°œ\n`;
          });
        }

        text += `\nğŸ“ ìƒì„¸ ë³´ê¸°: ${shareUrl || '(ë§í¬ ìƒì„± í•„ìš”)'}`;
        return text;
      };

      return (
        <div className="p-4 space-y-4">
          {/* ê³µìœ  í—¤ë” */}
          <div className="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl p-4 text-center">
            <p className="text-3xl mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</p>
            <h3 className="font-bold text-lg">ê°€ì¡±/ë™í–‰ì ê³µìœ </h3>
            <p className="text-xs text-blue-200 mt-1">ì—¬í–‰ ê³„íšì„ í•¨ê»˜ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
          </div>

          {/* ê³µìœ  ë§í¬ ìƒì„± */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h4 className="font-bold text-sm text-gray-900 mb-3">ğŸ”— ê³µìœ  ë§í¬</h4>
            {!shareUrl ? (
              <button onClick={createShareLink} disabled={sharing}
                className="w-full py-3 bg-primary-600 text-white rounded-xl font-medium text-sm hover:bg-primary-700 disabled:opacity-50 transition-all">
                {sharing ? 'â³ ë§í¬ ìƒì„± ì¤‘...' : 'ğŸ“ ê³µìœ  ë§í¬ ìƒì„±í•˜ê¸°'}
              </button>
            ) : (
              <div className="space-y-2">
                <div className="flex gap-2">
                  <input type="text" readOnly value={shareUrl}
                    className="flex-1 text-xs border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-gray-700" />
                  <button onClick={() => copyToClipboard(shareUrl)}
                    className={`px-3 py-2 rounded-lg text-xs font-medium transition-all ${copied ? 'bg-green-500 text-white' : 'bg-primary-600 text-white hover:bg-primary-700'}`}>
                    {copied ? 'âœ… ë³µì‚¬ë¨' : 'ğŸ“‹ ë³µì‚¬'}
                  </button>
                </div>
                <p className="text-xs text-gray-400">ë§í¬ë¥¼ ë°›ì€ ì‚¬ëŒì€ ì—¬í–‰ ê³„íšì„ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
              </div>
            )}
          </div>

          {/* ë©”ì‹ ì € ê³µìœ  */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h4 className="font-bold text-sm text-gray-900 mb-3">ğŸ’¬ ë©”ì‹ ì €ë¡œ ê³µìœ </h4>
            <div className="grid grid-cols-4 gap-2">
              {[
                { id: 'kakao', icon: 'ğŸ’¬', label: 'ì¹´ì¹´ì˜¤í†¡', color: 'bg-yellow-400' },
                { id: 'line', icon: 'ğŸ’š', label: 'LINE', color: 'bg-green-500' },
                { id: 'sms', icon: 'ğŸ“±', label: 'ë¬¸ì', color: 'bg-blue-500' },
                { id: 'email', icon: 'ğŸ“§', label: 'ì´ë©”ì¼', color: 'bg-gray-600' }
              ].map(m => (
                <button key={m.id} onClick={() => {
                  if (!shareUrl) { createShareLink().then(() => shareVia(m.id)); }
                  else shareVia(m.id);
                }}
                  className="flex flex-col items-center gap-1 p-3 rounded-xl hover:bg-gray-50 transition-all">
                  <span className={`w-10 h-10 ${m.color} rounded-full flex items-center justify-center text-white text-lg`}>
                    {m.icon}
                  </span>
                  <span className="text-xs text-gray-600">{m.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* í…ìŠ¤íŠ¸ ìš”ì•½ ë³µì‚¬ */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h4 className="font-bold text-sm text-gray-900 mb-3">ğŸ“ í…ìŠ¤íŠ¸ ìš”ì•½ ë³µì‚¬</h4>
            <div className="bg-gray-50 rounded-lg p-3 text-xs text-gray-700 whitespace-pre-wrap max-h-40 overflow-y-auto mb-2">
              {generateTextSummary()}
            </div>
            <button onClick={() => copyToClipboard(generateTextSummary())}
              className="w-full py-2 bg-gray-100 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-200 transition-all">
              ğŸ“‹ ìš”ì•½ í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>
          </div>

          {/* ê³µìœ ëœ ë©¤ë²„ (ë¯¸ë˜ í™•ì¥ìš©) */}
          <div className="bg-white border border-gray-200 rounded-xl p-4">
            <h4 className="font-bold text-sm text-gray-900 mb-3">ğŸ‘¥ ê³µìœ  ë©¤ë²„</h4>
            <div className="space-y-2">
              <div className="flex items-center gap-3 p-2 bg-primary-50 rounded-lg">
                <div className="w-8 h-8 bg-primary-200 rounded-full flex items-center justify-center text-xs font-bold text-primary-700">ë‚˜</div>
                <div className="flex-1">
                  <p className="text-sm font-medium text-gray-900">ë‚˜ (ê³„íšì)</p>
                  <p className="text-xs text-gray-500">ëª¨ë“  ê¶Œí•œ</p>
                </div>
                <span className="text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full">ê´€ë¦¬ì</span>
              </div>
              <p className="text-xs text-gray-400 text-center mt-2">ê³µìœ  ë§í¬ë¡œ ì´ˆëŒ€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>
          </div>
        </div>
      );
    }

    // â”€â”€â”€ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PinGate><App /></PinGate>);

    // PWA Service Worker ë“±ë¡ + ê°•ì œ ì—…ë°ì´íŠ¸
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        reg.update();
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      }).catch(() => {});
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
  </script>
</body>
</html>
